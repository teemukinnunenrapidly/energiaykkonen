<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E1 Widget WordPress Debug - Enhanced</title>
    <style>
        body { 
            font-family: system-ui; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .debug-panel { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .widget-container { 
            background: #ffffff; 
            border: 2px solid #e5e7eb; 
            padding: 20px; 
            border-radius: 12px; 
            margin: 20px 0; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { 
            background: #d1fae5; 
            color: #065f46; 
        }
        .error { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        .warning { 
            background: #fef3c7; 
            color: #92400e; 
        }
        .info { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        .log-container {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
        }
        .test-result {
            margin-top: 8px;
            font-weight: bold;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button.retry {
            background: #f59e0b;
        }
        button.retry:hover {
            background: #d97706;
        }
        .timeline {
            border-left: 3px solid #e5e7eb;
            margin-left: 10px;
            padding-left: 15px;
        }
        .timeline-item {
            margin: 10px 0;
            padding: 10px;
            background: #f9fafb;
            border-radius: 4px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #9ca3af;
        }
        .timeline-item.success::before {
            background: #10b981;
        }
        .timeline-item.error::before {
            background: #ef4444;
        }
        .timeline-item.warning::before {
            background: #f59e0b;
        }
    </style>
</head>
<body>
    <h1>üîç E1 Widget WordPress Debug - Enhanced</h1>
    
    <div class="debug-panel">
        <h3>Quick Actions</h3>
        <button onclick="runFullDiagnostic()">üîÑ Run Full Diagnostic</button>
        <button onclick="testConfigLoad()">üìÅ Test Config Loading</button>
        <button onclick="testScriptLoad()">üì¶ Test Script Loading</button>
        <button onclick="clearLogs()">üßπ Clear Logs</button>
        <button class="retry" onclick="retryWidgetInit()">üîÑ Retry Widget Init</button>
    </div>

    <div class="debug-panel">
        <h3>System Status</h3>
        <div id="system-status" class="test-grid">
            <div class="test-item">
                <strong>WordPress Environment</strong>
                <div id="wp-status" class="test-result">Checking...</div>
            </div>
            <div class="test-item">
                <strong>jQuery Availability</strong>
                <div id="jquery-status" class="test-result">Checking...</div>
            </div>
            <div class="test-item">
                <strong>DOM Ready State</strong>
                <div id="dom-status" class="test-result">Checking...</div>
            </div>
            <div class="test-item">
                <strong>Widget Container</strong>
                <div id="container-status" class="test-result">Checking...</div>
            </div>
        </div>
    </div>

    <div class="debug-panel">
        <h3>File Availability Tests</h3>
        <div id="file-tests" class="test-grid">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <div class="debug-panel">
        <h3>Initialization Timeline</h3>
        <div id="init-timeline" class="timeline">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <div class="debug-panel">
        <h3>Widget Test Area</h3>
        <div class="widget-container">
            <div id="e1-calculator-widget-debug" 
                 data-e1-calculator
                 data-shadow="false"
                 data-auto-init="false"
                 data-debug="true"
                 data-config-url="/wp-content/uploads/e1-calculator-cache/config.json"
                 style="min-height: 400px;">
                
                <div class="e1-calculator-loading" role="status">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="margin-bottom: 20px;">üîÑ</div>
                        <p>Ladataan E1-laskuria...</p>
                        <div id="loading-progress" style="margin-top: 10px; font-size: 12px;">
                            Initializing...
                        </div>
                    </div>
                </div>
                
                <div class="e1-calculator-error" style="display: none;" role="alert">
                    <h4>Initialization Error</h4>
                    <div id="error-details"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-panel">
        <h3>Console Logs</h3>
        <div id="console-logs" class="log-container"></div>
    </div>

    <script>
        // Debug utilities
        const DebugUtils = {
            startTime: Date.now(),
            logs: [],
            testResults: {},
            
            log(level, message, data = null) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
                
                if (data) {
                    console[level](logEntry, data);
                } else {
                    console[level](logEntry);
                }
                
                this.logs.push({ timestamp, level, message, data });
                this.updateLogDisplay();
            },
            
            updateLogDisplay() {
                const container = document.getElementById('console-logs');
                container.textContent = this.logs.map(log => {
                    let line = `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}`;
                    if (log.data) {
                        line += `\n  Data: ${JSON.stringify(log.data, null, 2)}`;
                    }
                    return line;
                }).join('\n');
                container.scrollTop = container.scrollHeight;
            },
            
            addTimelineItem(message, status = 'info', data = null) {
                const timeline = document.getElementById('init-timeline');
                const item = document.createElement('div');
                item.className = `timeline-item ${status}`;
                item.innerHTML = `
                    <strong>${message}</strong>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        ${Date.now() - this.startTime}ms since start
                    </div>
                    ${data ? `<pre style="font-size: 11px; margin-top: 8px; background: #f3f4f6; padding: 8px; border-radius: 3px;">${JSON.stringify(data, null, 2)}</pre>` : ''}
                `;
                timeline.appendChild(item);
                timeline.scrollTop = timeline.scrollHeight;
            }
        };

        // Override console methods to capture logs
        ['log', 'info', 'warn', 'error'].forEach(method => {
            const original = console[method];
            console[method] = (...args) => {
                original.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && args[0].includes('E1')) {
                    DebugUtils.log(method, args[0], args.slice(1));
                }
            };
        });

        // System status checks
        function checkSystemStatus() {
            DebugUtils.addTimelineItem('Starting system status check', 'info');
            
            // WordPress check
            const wpStatus = document.getElementById('wp-status');
            const hasWP = typeof window.wp !== 'undefined';
            const hasAjax = typeof window.ajaxurl !== 'undefined';
            wpStatus.innerHTML = hasWP || hasAjax ? 
                '<span class="success">‚úì Available</span>' : 
                '<span class="error">‚úó Not detected</span>';
            
            // jQuery check
            const jqStatus = document.getElementById('jquery-status');
            const hasJQ = typeof window.jQuery !== 'undefined';
            jqStatus.innerHTML = hasJQ ? 
                '<span class="success">‚úì Available (' + window.jQuery.fn.jquery + ')</span>' : 
                '<span class="error">‚úó Not available</span>';
            
            // DOM check
            const domStatus = document.getElementById('dom-status');
            domStatus.innerHTML = document.readyState === 'complete' ? 
                '<span class="success">‚úì Complete</span>' : 
                '<span class="warning">‚ö† ' + document.readyState + '</span>';
            
            // Container check
            const containerStatus = document.getElementById('container-status');
            const container = document.getElementById('e1-calculator-widget-debug');
            containerStatus.innerHTML = container ? 
                '<span class="success">‚úì Found</span>' : 
                '<span class="error">‚úó Missing</span>';
            
            DebugUtils.addTimelineItem('System status check completed', 'success', {
                wordpress: hasWP || hasAjax,
                jquery: hasJQ,
                domReady: document.readyState === 'complete',
                container: !!container
            });
        }

        // File availability tests
        async function testFileAvailability() {
            DebugUtils.addTimelineItem('Testing file availability', 'info');
            
            const files = [
                '/wp-content/uploads/e1-calculator-cache/config.json',
                '/wp-content/uploads/e1-calculator-cache/widget.js',
                '/wp-content/uploads/e1-calculator-cache/widget.css',
                '/wp-content/uploads/e1-calculator-cache/wordpress-loader.js'
            ];
            
            const container = document.getElementById('file-tests');
            container.innerHTML = '';
            
            for (const file of files) {
                const testItem = document.createElement('div');
                testItem.className = 'test-item';
                testItem.innerHTML = `
                    <strong>${file.split('/').pop()}</strong>
                    <div class="test-result" id="file-${file.split('/').pop().replace('.', '-')}">Testing...</div>
                `;
                container.appendChild(testItem);
                
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const result = document.getElementById(`file-${file.split('/').pop().replace('.', '-')}`);
                    if (response.ok) {
                        result.innerHTML = '<span class="success">‚úì Available (' + response.headers.get('content-length') + ' bytes)</span>';
                        DebugUtils.log('info', `File available: ${file}`);
                    } else {
                        result.innerHTML = '<span class="error">‚úó HTTP ' + response.status + '</span>';
                        DebugUtils.log('error', `File not available: ${file} - HTTP ${response.status}`);
                    }
                } catch (error) {
                    const result = document.getElementById(`file-${file.split('/').pop().replace('.', '-')}`);
                    result.innerHTML = '<span class="error">‚úó ' + error.message + '</span>';
                    DebugUtils.log('error', `File test failed: ${file}`, error);
                }
            }
            
            DebugUtils.addTimelineItem('File availability test completed', 'success');
        }

        // Test config loading
        async function testConfigLoad() {
            DebugUtils.addTimelineItem('Testing config loading', 'info');
            
            try {
                const response = await fetch('/wp-content/uploads/e1-calculator-cache/config.json?v=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const config = await response.json();
                DebugUtils.log('info', 'Config loaded successfully', {
                    version: config.version,
                    cardCount: config.data?.cards?.length || 0,
                    visualCount: config.data?.visuals?.length || 0
                });
                DebugUtils.addTimelineItem('Config loaded successfully', 'success', {
                    version: config.version,
                    cards: config.data?.cards?.length || 0,
                    visuals: config.data?.visuals?.length || 0
                });
            } catch (error) {
                DebugUtils.log('error', 'Config loading failed', error);
                DebugUtils.addTimelineItem('Config loading failed', 'error', error.message);
            }
        }

        // Test script loading
        async function testScriptLoad() {
            DebugUtils.addTimelineItem('Testing script loading', 'info');
            
            // Test WordPress loader
            const loaderScript = document.createElement('script');
            loaderScript.src = '/wp-content/uploads/e1-calculator-cache/wordpress-loader.js?v=' + Date.now();
            loaderScript.onload = () => {
                DebugUtils.log('info', 'WordPress loader script loaded');
                DebugUtils.addTimelineItem('WordPress loader script loaded', 'success');
                
                // Check if E1Calculator is available
                if (window.E1Calculator) {
                    DebugUtils.log('info', 'E1Calculator object available', Object.keys(window.E1Calculator));
                    DebugUtils.addTimelineItem('E1Calculator object available', 'success', Object.keys(window.E1Calculator));
                } else {
                    DebugUtils.log('warn', 'E1Calculator object not available after loader');
                    DebugUtils.addTimelineItem('E1Calculator object not available', 'warning');
                }
            };
            loaderScript.onerror = (error) => {
                DebugUtils.log('error', 'WordPress loader script failed to load', error);
                DebugUtils.addTimelineItem('WordPress loader script failed', 'error');
            };
            
            document.head.appendChild(loaderScript);
            
            // Test main widget script
            setTimeout(() => {
                const widgetScript = document.createElement('script');
                widgetScript.src = '/wp-content/uploads/e1-calculator-cache/widget.js?v=' + Date.now();
                widgetScript.onload = () => {
                    DebugUtils.log('info', 'Main widget script loaded');
                    DebugUtils.addTimelineItem('Main widget script loaded', 'success');
                };
                widgetScript.onerror = (error) => {
                    DebugUtils.log('error', 'Main widget script failed to load', error);
                    DebugUtils.addTimelineItem('Main widget script failed', 'error');
                };
                document.head.appendChild(widgetScript);
            }, 1000);
        }

        // Retry widget initialization
        async function retryWidgetInit() {
            DebugUtils.addTimelineItem('Retrying widget initialization', 'info');
            
            const container = document.getElementById('e1-calculator-widget-debug');
            const loadingEl = container.querySelector('.e1-calculator-loading');
            const errorEl = container.querySelector('.e1-calculator-error');
            
            // Reset UI
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';
            
            try {
                if (window.E1Calculator && window.E1Calculator.init) {
                    DebugUtils.log('info', 'Attempting E1Calculator.init');
                    const result = await window.E1Calculator.init({
                        containerId: 'e1-calculator-widget-debug',
                        useShadowDOM: false,
                        configUrl: '/wp-content/uploads/e1-calculator-cache/config.json',
                        debug: true
                    });
                    DebugUtils.log('info', 'Widget initialization result', result);
                    DebugUtils.addTimelineItem('Widget initialized successfully', 'success', result);
                } else {
                    throw new Error('E1Calculator.init not available');
                }
            } catch (error) {
                DebugUtils.log('error', 'Widget initialization failed', error);
                DebugUtils.addTimelineItem('Widget initialization failed', 'error', error.message);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) {
                    errorEl.style.display = 'block';
                    const detailsEl = document.getElementById('error-details');
                    if (detailsEl) {
                        detailsEl.innerHTML = `
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>E1Calculator available:</strong> ${!!window.E1Calculator}</p>
                            <p><strong>Available methods:</strong> ${window.E1Calculator ? Object.keys(window.E1Calculator).join(', ') : 'N/A'}</p>
                        `;
                    }
                }
            }
        }

        // Run full diagnostic
        async function runFullDiagnostic() {
            DebugUtils.addTimelineItem('Starting full diagnostic', 'info');
            clearLogs();
            
            checkSystemStatus();
            await testFileAvailability();
            await testConfigLoad();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait a bit
            await testScriptLoad();
            
            DebugUtils.addTimelineItem('Full diagnostic completed', 'success');
        }

        // Clear logs
        function clearLogs() {
            DebugUtils.logs = [];
            DebugUtils.updateLogDisplay();
            document.getElementById('init-timeline').innerHTML = '';
            DebugUtils.startTime = Date.now();
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            DebugUtils.log('info', 'Debug page loaded');
            checkSystemStatus();
            
            // Auto-run diagnostic after a short delay
            setTimeout(runFullDiagnostic, 1000);
        });

        // Monitor for E1Calculator availability
        const checkE1Calculator = () => {
            if (window.E1Calculator) {
                DebugUtils.log('info', 'E1Calculator detected!', Object.keys(window.E1Calculator));
                DebugUtils.addTimelineItem('E1Calculator detected', 'success', Object.keys(window.E1Calculator));
                return true;
            }
            return false;
        };

        // Check every second for E1Calculator
        let checkInterval = setInterval(() => {
            if (checkE1Calculator()) {
                clearInterval(checkInterval);
            }
        }, 1000);

        // Stop checking after 30 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            if (!window.E1Calculator) {
                DebugUtils.log('warn', 'E1Calculator not detected after 30 seconds');
                DebugUtils.addTimelineItem('E1Calculator not detected after 30s', 'warning');
            }
        }, 30000);
    </script>
</body>
</html>