"use strict";(this.webpackChunkE1Calculator=this.webpackChunkE1Calculator||[]).push([[846],{846:(e,t,r)=>{r.d(t,{UnifiedCalculationEngine:()=>i});var s=r(215),a=r(602);class o{lookupCache=(()=>new Map)();rulesCache=(()=>new Map)();defaultsCache=(()=>new Map)();cacheTimestamp=0;CACHE_TTL=3e5;constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}async executeLookup(e,t){const r=performance.now();try{await this.ensureCacheLoaded();const s=this.lookupCache.get(e);if(!s||!s.is_active)return{success:!1,error:`Lookup '${e}' not found or inactive`,used_default:!1,execution_time_ms:performance.now()-r};const a=this.rulesCache.get(s.id)||[],o=t.enableDebug?{lookup_name:e,input_values:{...t.formData},evaluated_rules:[]}:void 0;for(const e of a){if(!e.is_active)continue;const a=this.evaluateCondition(e.condition_logic,t.formData);if(o&&o.evaluated_rules.push({rule_id:e.id,rule_name:e.name,condition_result:a,condition_details:e.condition_logic}),a){const a=await this.executeAction(e.action_type,e.action_config,t),n={success:a.success,value:a.value,error:a.error,matched_rule_id:e.id,used_default:!1,execution_time_ms:performance.now()-r,debug_info:o};return t.enableLogging&&await this.logExecution(s,n,t),n}}const n=this.defaultsCache.get(s.id);if(n){const e=await this.executeAction(n.action_type,n.action_config,t),a={success:e.success,value:e.value,error:e.error,matched_rule_id:void 0,used_default:!0,execution_time_ms:performance.now()-r,debug_info:o};return t.enableLogging&&await this.logExecution(s,a,t),a}return{success:!1,error:`No rules matched for lookup '${e}' and no default action configured`,used_default:!1,execution_time_ms:performance.now()-r,debug_info:o}}catch(e){return{success:!1,error:`Enhanced lookup execution failed: ${e instanceof Error?e.message:"Unknown error"}`,used_default:!1,execution_time_ms:performance.now()-r}}}evaluateCondition(e,t){if(!e.conditions||0===e.conditions.length)return!0;const r=e.conditions.map(e=>this.evaluateSingleCondition(e,t));return"AND"===e.type?r.every(e=>e):r.some(e=>e)}evaluateSingleCondition(e,t){const r=t[e.field],s=e.value;if(null==r)return"not_equals"===e.operator||"not_in"===e.operator;switch(e.operator){case"equals":return r===s;case"not_equals":return r!==s;case"greater_than":return Number(r)>Number(s);case"greater_than_or_equal":return Number(r)>=Number(s);case"less_than":return Number(r)<Number(s);case"less_than_or_equal":return Number(r)<=Number(s);case"contains":return String(r).toLowerCase().includes(String(s).toLowerCase());case"starts_with":return String(r).toLowerCase().startsWith(String(s).toLowerCase());case"ends_with":return String(r).toLowerCase().endsWith(String(s).toLowerCase());case"in":return Array.isArray(s)&&s.includes(r);case"not_in":return Array.isArray(s)&&!s.includes(r);default:return!1}}async executeAction(e,t,r){switch(e){case"formula":return await this.executeFormulaAction(t,r);case"value":return this.executeValueAction(t);case"lookup":return await this.executeLookupTableAction(t,r);case"error":return{success:!1,error:t.message||"Lookup resulted in configured error"};default:return{success:!1,error:`Unknown action type: ${e}`}}}async executeFormulaAction(e,t){if(!e.formula_text)return{success:!1,error:"Formula action missing formula_text"};try{const r=new i(s.supabase,t.sessionId,t.formData),a=await r.process(e.formula_text);if(a.success&&void 0!==a.result){let t;const r=String(a.result).replace(/\s/g,"").replace(/,/g,".").match(/^([+-]?[0-9]*\.?[0-9]+)/);r&&(t=parseFloat(r[1]));let o=a.result;if(void 0!==t){const r=e.formula_text?.match(/\[calc:([^\]]+)\]/);if(r){const e=r[1],{data:a}=await s.supabase.from("formulas").select("unit").eq("name",e).single();o=a?.unit?`${t.toLocaleString("fi-FI")} ${a.unit}`:t.toLocaleString("fi-FI")}}return{success:!0,value:o}}return{success:!1,error:a.error||"Formula execution failed"}}catch(e){return{success:!1,error:`Formula execution error: ${e instanceof Error?e.message:"Unknown error"}`}}}executeValueAction(e){return void 0===e.value?{success:!1,error:"Value action missing value"}:{success:!0,value:e.value}}async executeLookupTableAction(e,t){if(!e.lookup_table||!e.key_field||!e.value_field)return{success:!1,error:"Lookup table action missing required configuration"};try{const r=t.formData[e.key_field];if(null==r)return{success:!1,error:`Key field '${e.key_field}' not found in form data`};const{data:a,error:o}=await s.supabase.from(e.lookup_table).select(e.value_field).eq(e.key_field,r).single();return o?{success:!1,error:`Lookup table query failed: ${o.message}`}:a?{success:!0,value:a[e.value_field]}:{success:!1,error:`No matching record found in ${e.lookup_table} for ${e.key_field}='${r}'`}}catch(e){return{success:!1,error:`Lookup table error: ${e instanceof Error?e.message:"Unknown error"}`}}}async ensureCacheLoaded(){const e=Date.now();e-this.cacheTimestamp<this.CACHE_TTL||(await this.loadCache(),this.cacheTimestamp=e)}async loadCache(){try{const{data:e,error:t}=await s.supabase.from("enhanced_lookups").select("*").eq("is_active",!0);if(t)throw t;const{data:r,error:a}=await s.supabase.from("enhanced_lookup_rules").select("*").eq("is_active",!0).order("lookup_id, order_index");if(a)throw a;const{data:o,error:n}=await s.supabase.from("enhanced_lookup_defaults").select("*");if(n)throw n;this.lookupCache.clear(),this.rulesCache.clear(),this.defaultsCache.clear(),e?.forEach(e=>{this.lookupCache.set(e.name,e)}),r?.forEach(e=>{this.rulesCache.has(e.lookup_id)||this.rulesCache.set(e.lookup_id,[]),this.rulesCache.get(e.lookup_id).push(e)}),o?.forEach(e=>{this.defaultsCache.set(e.lookup_id,e)})}catch(e){throw e}}async logExecution(e,t,r){try{await s.supabase.from("enhanced_lookup_executions").insert({session_id:r.sessionId,lookup_id:e.id,lookup_name:e.name,input_values:r.formData,matched_rule_id:t.matched_rule_id,used_default:t.used_default,result_value:t.value,result_error:t.error,execution_time_ms:Math.round(t.execution_time_ms)})}catch(e){}}clearCache(){this.lookupCache.clear(),this.rulesCache.clear(),this.defaultsCache.clear(),this.cacheTimestamp=0}getCacheStats(){const e=Date.now();return{lookups:this.lookupCache.size,rules:Array.from(this.rulesCache.values()).reduce((e,t)=>e+t.length,0),defaults:this.defaultsCache.size,cacheAge:e-this.cacheTimestamp,isStale:e-this.cacheTimestamp>=this.CACHE_TTL}}async testLookup(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"test";return await this.executeLookup(e,{sessionId:r,formData:t,enableDebug:!0,enableLogging:!1})}}function n(){return o.getInstance()}class i{cache=(()=>new Map)();formulasCache=null;constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.context={sessionId:t,formData:r,maxDepth:10,batchSize:10}}clearCache(){this.cache.clear()}async process(e){const t=performance.now();try{if(!e||"string"!=typeof e)return{success:!0,result:e||"",processedCount:0,executionTime:performance.now()-t,dependencies:[]};const r=this.extractDependencies(e),s=await this.extractFieldDependencies(e);if(0===r.size)return{success:!0,result:e,processedCount:0,executionTime:performance.now()-t,dependencies:s};const a=await this.resolveDependencies(r);return{success:!0,result:this.evaluateWithDependencies(e,a),processedCount:r.size,executionTime:performance.now()-t,dependencies:s}}catch(e){return{success:!1,error:`Processing failed: ${e instanceof Error?e.message:"Unknown error"}`,processedCount:0,executionTime:performance.now()-t,dependencies:[]}}}async extractFieldDependencies(e){const t=new Set,r=new Set;return await this._extractFieldDepsRecursive(e,t,r),Array.from(t)}async _extractFieldDepsRecursive(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(s>5)return;const a=/\{([^}]+)\}/g;let o;for(;null!==(o=a.exec(e));)t.add(o[1]);const n=/\[(\w+):([^\]]+)\]/g;for(;null!==(o=n.exec(e));){const e=o[1],a=o[2],n=`${e}:${a}`;if(!r.has(n))if(r.add(n),"field"===e)t.add(a);else if("calc"===e){const e=(await this.getFormulas()).find(e=>e.name.toLowerCase()===a.toLowerCase()||e.name.toLowerCase().replace(/\s+/g,"-")===a.toLowerCase());e?.formula_text&&await this._extractFieldDepsRecursive(e.formula_text,t,r,s+1)}else"lookup"===e&&await this._extractLookupFieldDeps(a,t,r,s+1)}}async _extractLookupFieldDeps(e,t,r,a){if(!(a>5))try{const{data:o}=await s.supabase.from("enhanced_lookups").select("id").eq("name",e).eq("is_active",!0).single();if(o){const{data:e}=await s.supabase.from("enhanced_lookup_rules").select("condition_logic, action_config").eq("lookup_id",o.id).eq("is_active",!0);if(e)for(const s of e){if(s.condition_logic?.conditions)for(const e of s.condition_logic.conditions)e.field&&t.add(e.field);s.action_config?.formula_text&&await this._extractFieldDepsRecursive(s.action_config.formula_text,t,r,a+1)}}}catch(e){}}extractDependencies(e){const t=new Set,r=/\[(\w+):([^\]]+)\]|\{([^}]+)\}/g;let s;for(;null!==(s=r.exec(e));)s[1]&&s[2]?t.add(`${s[1]}:${s[2]}`):s[3]&&t.add(`field:${s[3]}`);return t}async resolveDependencies(e){const t=new Map,r=Array.from(e),s=new Set;let a=0;for(;r.length>0&&a<this.context.maxDepth;){const e=r.splice(0,this.context.batchSize),o=await Promise.allSettled(e.map(e=>this.resolveSingleDependency(e)));for(let a=0;a<o.length;a++){const n=o[a],i=e[a];if("fulfilled"===n.status&&n.value){const e=n.value;t.set(i,e),s.add(i);this.extractDependencies(e.processed).forEach(e=>{s.has(e)||r.includes(e)||r.push(e)}),this.cache.set(i,e),this._persistValue().catch(console.error)}}a++}return this.context.maxDepth,t}async resolveSingleDependency(e){const t=this.cache.get(e);if(t)return t;const[r,s]=e.split(":",2),a={id:`${this.context.sessionId}:${e}`,type:this.determineType(e),raw:e,processed:"",dependencies:[],timestamp:new Date};try{switch(r){case"field":a.processed=this.resolveField(s);break;case"calc":a.processed=await this.resolveCalculation(s);break;case"lookup":a.processed=await this.resolveLookup(s);break;default:a.processed=e}return a}catch(e){return a.processed=`[Error: ${e instanceof Error?e.message:"Unknown error"}]`,a}}resolveField(e){const t=this.context.formData[e];if(null==t||""===t)throw new Error(`Field '${e}' is required but has no value`);return String(t)}async resolveCalculation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=[`override_${e}`,`override_${e.replace(/-/g,"_")}`,`override_${e.replace(/_/g,"-")}`];for(const e of r){const t=this.context.formData[e];if(null!=t&&""!==t)return String(t)}if(t>5)throw new Error(`Maximum formula recursion depth exceeded for '${e}'`);const s=(await this.getFormulas()).find(t=>t.name.toLowerCase()===e.toLowerCase()||t.name.toLowerCase().replace(/\s+/g,"-")===e.toLowerCase());if(!s)throw new Error(`Formula '${e}' not found`);const a=await this.processFormulaText(s.formula_text,t+1);return String(a)}async processFormulaText(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e;const s=e.match(/\[field:([^\]]+)\]/g)||[];for(const e of s){const t=e.match(/\[field:([^\]]+)\]/);if(t){const s=t[1],a=this.context.formData[s];if(null==a||""===a)throw new Error(`Field '${s}' not found in form data`);r=r.replace(e,String(a))}}const a=e.match(/\[calc:([^\]]+)\]/g)||[];for(const e of a){const s=e.match(/\[calc:([^\]]+)\]/);if(s){const a=s[1],o=await this.resolveCalculation(a,t);r=r.replace(e,o)}}if(this.isEvaluableExpression(r))return this.evaluateMathExpression(r);{const e=parseFloat(r);if(isNaN(e))throw new Error(`Cannot evaluate formula result: ${r}`);return e}}async resolveLookup(e){try{const t=await async function(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const a=n();return await a.executeLookup(e,{sessionId:t,formData:r,enableLogging:s.enableLogging??!1,enableDebug:s.enableDebug??!1})}(e,this.context.sessionId,this.context.formData,{enableLogging:!0});if(t.success&&void 0!==t.value)return String(t.numericValue??t.value);if(t.error&&t.error.includes("not found")){const t=await(0,a.x3)(e,this.context.sessionId,this.context.formData);if(t.success)return t.shortcode||t.error||"[Lookup result unavailable]";throw new Error(`Legacy lookup failed: ${t.error}`)}throw new Error(`Enhanced lookup failed: ${t.error}`)}catch(e){throw new Error(`Lookup failed: ${e instanceof Error?e.message:"Unknown error"}`)}}evaluateWithDependencies(e,t){let r=e;for(const[e,s]of t){const[t,a]=e.split(":",2);let o;o="field"===t?new RegExp(`\\{${this.escapeRegExp(a)}\\}`,"g"):new RegExp(`\\[${t}:${this.escapeRegExp(a)}\\]`,"g"),r=r.replace(o,s.processed)}if(this.isEvaluableExpression(r))try{return this.evaluateMathExpression(r).toString()}catch(e){}return r}isEvaluableExpression(e){return/^[\d+\-*/().\s]+$/.test(e.trim())&&/[+\-*/()]/.test(e)}evaluateMathExpression(e){let t=e.replace(/,/g,".");if(t=t.replace(/\s/g,""),!/^[0-9+\-*/().\s]+$/.test(t))throw new Error("Expression contains invalid characters");if((t.match(/\(/g)||[]).length!==(t.match(/\)/g)||[]).length)throw new Error("Unbalanced parentheses");const r=new Function("return "+t)();if("number"!=typeof r||isNaN(r)||!isFinite(r))throw new Error("Expression did not evaluate to a valid number");return r}async getFormulas(){if(this.formulasCache&&Date.now()-this.formulasCache.timestamp<this.formulasCache.ttl)return this.formulasCache.formulas;const{data:e,error:t}=await s.supabase.from("formulas").select("*").eq("is_active",!0).order("name");if(t)throw new Error(`Failed to fetch formulas: ${t.message}`);return this.formulasCache={formulas:e||[],timestamp:Date.now(),ttl:3e5},e||[]}determineType(e){return e.includes("field:")?"field":e.includes("calc:")?"calculation":e.includes("lookup:")?"lookup":"static"}inferUnit(e){const t=e.toLowerCase();return t.includes("energiantarve")&&t.includes("kwh")?"kW":t.includes("Ã¶ljyn menekki")?"L/vuosi":t.includes("kaasun menekki")?"MWh/vuosi":t.includes("puun menekki")?"motti/vuosi":""}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async _persistValue(){}async loadCachedValues(){try{const{data:e,error:t}=await s.supabase.from("processed_values").select("*").eq("session_id",this.context.sessionId).gte("updated_at",new Date(Date.now()-864e5).toISOString());if(t)return;if(e)for(const t of e){const e={id:t.value_id,type:t.type,raw:t.raw,processed:t.processed,dependencies:t.dependencies||[],timestamp:new Date(t.updated_at)},r=t.raw;this.cache.set(r,e)}}catch(e){}}getCacheStats(){return{size:this.cache.size,entries:Array.from(this.cache.keys())}}updateFormData(e){this.context.formData={...this.context.formData,...e}}}}}]);