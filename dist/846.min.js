"use strict";(this.webpackChunkE1CalculatorWidget=this.webpackChunkE1CalculatorWidget||[]).push([[846],{846:function(e,t,o){o.d(t,{UnifiedCalculationEngine:function(){return i}});var a=o(215),r=o(602);class s{lookupCache=(()=>new Map)();rulesCache=(()=>new Map)();defaultsCache=(()=>new Map)();cacheTimestamp=0;CACHE_TTL=3e5;constructor(){}static getInstance(){return s.instance||(s.instance=new s),s.instance}async executeLookup(e,t){const o=performance.now();try{await this.ensureCacheLoaded();const a=this.lookupCache.get(e);if(!a||!a.is_active)return{success:!1,error:`Lookup '${e}' not found or inactive`,used_default:!1,execution_time_ms:performance.now()-o};const r=this.rulesCache.get(a.id)||[],s=t.enableDebug?{lookup_name:e,input_values:{...t.formData},evaluated_rules:[]}:void 0;for(const n of r){if(!n.is_active)continue;const r=this.evaluateCondition(n.condition_logic,t.formData);if("menekin-hinta"!==e&&"kokonaismenekki"!==e||console.log(`🔍 Evaluating rule for '${e}':`,{ruleId:n.id,ruleName:n.name,priority:n.order_index,conditionLogic:n.condition_logic,conditionMatches:r,availableFields:Object.keys(t.formData||{}),formDataValues:t.formData}),s&&s.evaluated_rules.push({rule_id:n.id,rule_name:n.name,condition_result:r,condition_details:n.condition_logic}),r){const e=await this.executeAction(n.action_type,n.action_config,t),r={success:e.success,value:e.value,error:e.error,matched_rule_id:n.id,used_default:!1,execution_time_ms:performance.now()-o,debug_info:s};return t.enableLogging&&await this.logExecution(a,r,t),r}}const n=this.defaultsCache.get(a.id);if(n){const e=await this.executeAction(n.action_type,n.action_config,t),r={success:e.success,value:e.value,error:e.error,matched_rule_id:void 0,used_default:!0,execution_time_ms:performance.now()-o,debug_info:s};return t.enableLogging&&await this.logExecution(a,r,t),r}return console.error(`❌ Lookup '${e}' failed:`,{availableRules:r.length,formData:t.formData,debugInfo:s}),{success:!1,error:`No rules matched for lookup '${e}' and no default action configured`,used_default:!1,execution_time_ms:performance.now()-o,debug_info:s}}catch(e){return{success:!1,error:`Enhanced lookup execution failed: ${e instanceof Error?e.message:"Unknown error"}`,used_default:!1,execution_time_ms:performance.now()-o}}}evaluateCondition(e,t){if(!e.conditions||0===e.conditions.length)return!0;const o=e.conditions.map(e=>this.evaluateSingleCondition(e,t));return"AND"===e.type?o.every(e=>e):o.some(e=>e)}evaluateSingleCondition(e,t){const o=t[e.field],a=e.value;if(null==o)return"not_equals"===e.operator||"not_in"===e.operator;switch(e.operator){case"equals":return o===a;case"not_equals":return o!==a;case"greater_than":return Number(o)>Number(a);case"greater_than_or_equal":return Number(o)>=Number(a);case"less_than":return Number(o)<Number(a);case"less_than_or_equal":return Number(o)<=Number(a);case"contains":return String(o).toLowerCase().includes(String(a).toLowerCase());case"starts_with":return String(o).toLowerCase().startsWith(String(a).toLowerCase());case"ends_with":return String(o).toLowerCase().endsWith(String(a).toLowerCase());case"in":return Array.isArray(a)&&a.includes(o);case"not_in":return Array.isArray(a)&&!a.includes(o);default:return console.warn(`Unknown condition operator: ${e.operator}`),!1}}async executeAction(e,t,o){switch(e){case"formula":return await this.executeFormulaAction(t,o);case"value":return this.executeValueAction(t);case"lookup":return await this.executeLookupTableAction(t,o);case"error":return{success:!1,error:t.message||"Lookup resulted in configured error"};default:return{success:!1,error:`Unknown action type: ${e}`}}}async executeFormulaAction(e,t){if(!e.formula_text)return{success:!1,error:"Formula action missing formula_text"};try{const o=new i(a.supabase,t.sessionId,t.formData),r=await o.process(e.formula_text);if(r.success&&void 0!==r.result){let t;const o=String(r.result).replace(/\s/g,"").replace(/,/g,".").match(/^([+-]?[0-9]*\.?[0-9]+)/);o&&(t=parseFloat(o[1]));let s=r.result;if(void 0!==t){const o=e.formula_text?.match(/\[calc:([^\]]+)\]/);if(o){const e=o[1],{data:r}=await a.supabase.from("formulas").select("unit").eq("name",e).single();s=r?.unit?`${t.toLocaleString("fi-FI")} ${r.unit}`:t.toLocaleString("fi-FI")}}return{success:!0,value:s}}return{success:!1,error:r.error||"Formula execution failed"}}catch(e){return{success:!1,error:`Formula execution error: ${e instanceof Error?e.message:"Unknown error"}`}}}executeValueAction(e){return void 0===e.value?{success:!1,error:"Value action missing value"}:{success:!0,value:e.value}}async executeLookupTableAction(e,t){if(!e.lookup_table||!e.key_field||!e.value_field)return{success:!1,error:"Lookup table action missing required configuration"};try{const o=t.formData[e.key_field];if(null==o)return{success:!1,error:`Key field '${e.key_field}' not found in form data`};const{data:r,error:s}=await a.supabase.from(e.lookup_table).select(e.value_field).eq(e.key_field,o).single();return s?{success:!1,error:`Lookup table query failed: ${s.message}`}:r?{success:!0,value:r[e.value_field]}:{success:!1,error:`No matching record found in ${e.lookup_table} for ${e.key_field}='${o}'`}}catch(e){return{success:!1,error:`Lookup table error: ${e instanceof Error?e.message:"Unknown error"}`}}}async ensureCacheLoaded(){const e=Date.now();e-this.cacheTimestamp<this.CACHE_TTL||(await this.loadCache(),this.cacheTimestamp=e)}async loadCache(){try{const{data:e,error:t}=await a.supabase.from("enhanced_lookups").select("*").eq("is_active",!0);if(t)throw t;const{data:o,error:r}=await a.supabase.from("enhanced_lookup_rules").select("*").eq("is_active",!0).order("lookup_id, order_index");if(r)throw r;const{data:s,error:n}=await a.supabase.from("enhanced_lookup_defaults").select("*");if(n)throw n;this.lookupCache.clear(),this.rulesCache.clear(),this.defaultsCache.clear(),e?.forEach(e=>{this.lookupCache.set(e.name,e)}),o?.forEach(e=>{this.rulesCache.has(e.lookup_id)||this.rulesCache.set(e.lookup_id,[]),this.rulesCache.get(e.lookup_id).push(e)}),s?.forEach(e=>{this.defaultsCache.set(e.lookup_id,e)}),console.log(`Enhanced lookup cache loaded: ${e?.length||0} lookups, ${o?.length||0} rules, ${s?.length||0} defaults`)}catch(e){throw console.error("Failed to load enhanced lookup cache:",e),e}}async logExecution(e,t,o){try{await a.supabase.from("enhanced_lookup_executions").insert({session_id:o.sessionId,lookup_id:e.id,lookup_name:e.name,input_values:o.formData,matched_rule_id:t.matched_rule_id,used_default:t.used_default,result_value:t.value,result_error:t.error,execution_time_ms:Math.round(t.execution_time_ms)})}catch(e){console.error("Failed to log enhanced lookup execution:",e)}}clearCache(){this.lookupCache.clear(),this.rulesCache.clear(),this.defaultsCache.clear(),this.cacheTimestamp=0}getCacheStats(){const e=Date.now();return{lookups:this.lookupCache.size,rules:Array.from(this.rulesCache.values()).reduce((e,t)=>e+t.length,0),defaults:this.defaultsCache.size,cacheAge:e-this.cacheTimestamp,isStale:e-this.cacheTimestamp>=this.CACHE_TTL}}async testLookup(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"test";return await this.executeLookup(e,{sessionId:o,formData:t,enableDebug:!0,enableLogging:!1})}}function n(){return s.getInstance()}class i{cache=(()=>new Map)();formulasCache=null;constructor(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.context={sessionId:t,formData:o,maxDepth:10,batchSize:10}}clearCache(){console.log("🧹 Clearing UnifiedCalculationEngine cache"),this.cache.clear()}async process(e){const t=performance.now();try{if(!e||"string"!=typeof e)return{success:!0,result:e||"",processedCount:0,executionTime:performance.now()-t,dependencies:[]};const o=this.extractDependencies(e),a=await this.extractFieldDependencies(e);if(0===o.size)return{success:!0,result:e,processedCount:0,executionTime:performance.now()-t,dependencies:a};const r=await this.resolveDependencies(o);return{success:!0,result:this.evaluateWithDependencies(e,r),processedCount:o.size,executionTime:performance.now()-t,dependencies:a}}catch(e){return{success:!1,error:`Processing failed: ${e instanceof Error?e.message:"Unknown error"}`,processedCount:0,executionTime:performance.now()-t,dependencies:[]}}}async extractFieldDependencies(e){const t=new Set,o=new Set;return await this._extractFieldDepsRecursive(e,t,o),Array.from(t)}async _extractFieldDepsRecursive(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(a>5)return;const r=/\{([^}]+)\}/g;let s;for(;null!==(s=r.exec(e));)t.add(s[1]);const n=/\[(\w+):([^\]]+)\]/g;for(;null!==(s=n.exec(e));){const e=s[1],r=s[2],n=`${e}:${r}`;if(!o.has(n))if(o.add(n),"field"===e)t.add(r);else if("calc"===e){const e=(await this.getFormulas()).find(e=>e.name.toLowerCase()===r.toLowerCase()||e.name.toLowerCase().replace(/\s+/g,"-")===r.toLowerCase());e?.formula_text&&await this._extractFieldDepsRecursive(e.formula_text,t,o,a+1)}else"lookup"===e&&await this._extractLookupFieldDeps(r,t,o,a+1)}}async _extractLookupFieldDeps(e,t,o,r){if(!(r>5))try{const{data:s}=await a.supabase.from("enhanced_lookups").select("id").eq("name",e).eq("is_active",!0).single();if(s){const{data:e}=await a.supabase.from("enhanced_lookup_rules").select("condition_logic, action_config").eq("lookup_id",s.id).eq("is_active",!0);if(e)for(const a of e){if(a.condition_logic?.conditions)for(const e of a.condition_logic.conditions)e.field&&t.add(e.field);a.action_config?.formula_text&&await this._extractFieldDepsRecursive(a.action_config.formula_text,t,o,r+1)}}}catch(t){console.warn(`Failed to extract lookup dependencies for ${e}:`,t)}}extractDependencies(e){const t=new Set,o=/\[(\w+):([^\]]+)\]|\{([^}]+)\}/g;let a;for(;null!==(a=o.exec(e));)a[1]&&a[2]?t.add(`${a[1]}:${a[2]}`):a[3]&&t.add(`field:${a[3]}`);return t}async resolveDependencies(e){const t=new Map,o=Array.from(e),a=new Set;let r=0;for(;o.length>0&&r<this.context.maxDepth;){const e=o.splice(0,this.context.batchSize),s=await Promise.allSettled(e.map(e=>this.resolveSingleDependency(e)));for(let r=0;r<s.length;r++){const n=s[r],i=e[r];if("fulfilled"===n.status&&n.value){const e=n.value;t.set(i,e),a.add(i);this.extractDependencies(e.processed).forEach(e=>{a.has(e)||o.includes(e)||o.push(e)}),this.cache.set(i,e),this._persistValue().catch(console.error)}}r++}return r>=this.context.maxDepth&&console.warn(`Reached maximum dependency depth (${this.context.maxDepth}). Some dependencies may not be resolved.`),t}async resolveSingleDependency(e){const t=this.cache.get(e);if(t)return t;const[o,a]=e.split(":",2),r={id:`${this.context.sessionId}:${e}`,type:this.determineType(e),raw:e,processed:"",dependencies:[],timestamp:new Date};try{switch(o){case"field":r.processed=this.resolveField(a);break;case"calc":r.processed=await this.resolveCalculation(a);break;case"lookup":r.processed=await this.resolveLookup(a);break;default:r.processed=e}return r}catch(e){return r.processed=`[Error: ${e instanceof Error?e.message:"Unknown error"}]`,r}}resolveField(e){const t=this.context.formData[e];if(null==t||""===t)throw new Error(`Field '${e}' is required but has no value`);return String(t)}async resolveCalculation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const o=[`override_${e}`,`override_${e.replace(/-/g,"_")}`,`override_${e.replace(/_/g,"-")}`];for(const t of o){const o=this.context.formData[t];if(null!=o&&""!==o)return console.log(`🔄 Using override value for '${e}' (key: ${t}): ${o} (instead of calculating)`),String(o)}if(t>5)throw new Error(`Maximum formula recursion depth exceeded for '${e}'`);const a=(await this.getFormulas()).find(t=>t.name.toLowerCase()===e.toLowerCase()||t.name.toLowerCase().replace(/\s+/g,"-")===e.toLowerCase());if(!a)throw new Error(`Formula '${e}' not found`);const r=await this.processFormulaText(a.formula_text,t+1);return String(r)}async processFormulaText(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=e;console.log(`📐 Processing formula: "${e}" (depth: ${t})`);const a=e.match(/\[field:([^\]]+)\]/g)||[];for(const e of a){const t=e.match(/\[field:([^\]]+)\]/);if(t){const a=t[1],r=this.context.formData[a];if(null==r||""===r)throw new Error(`Field '${a}' not found in form data`);o=o.replace(e,String(r))}}const r=e.match(/\[calc:([^\]]+)\]/g)||[];for(const e of r){const a=e.match(/\[calc:([^\]]+)\]/);if(a){const r=a[1],s=await this.resolveCalculation(r,t);o=o.replace(e,s)}}if(this.isEvaluableExpression(o))return this.evaluateMathExpression(o);{const e=parseFloat(o);if(isNaN(e))throw new Error(`Cannot evaluate formula result: ${o}`);return e}}async resolveLookup(e){try{const t=await async function(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=n();return await r.executeLookup(e,{sessionId:t,formData:o,enableLogging:a.enableLogging??!1,enableDebug:a.enableDebug??!1})}(e,this.context.sessionId,this.context.formData,{enableLogging:!0});if(t.success&&void 0!==t.value)return String(t.numericValue??t.value);if(t.error&&t.error.includes("not found")){console.log(`Enhanced lookup '${e}' not found, falling back to legacy system`);const t=await(0,r.x3)(e,this.context.sessionId,this.context.formData);if(t.success)return t.shortcode||t.error||"[Lookup result unavailable]";throw new Error(`Legacy lookup failed: ${t.error}`)}throw new Error(`Enhanced lookup failed: ${t.error}`)}catch(t){throw console.error(`Lookup resolution error for '${e}':`,t),new Error(`Lookup failed: ${t instanceof Error?t.message:"Unknown error"}`)}}evaluateWithDependencies(e,t){let o=e;for(const[e,a]of t){const[t,r]=e.split(":",2);let s;s="field"===t?new RegExp(`\\{${this.escapeRegExp(r)}\\}`,"g"):new RegExp(`\\[${t}:${this.escapeRegExp(r)}\\]`,"g"),o=o.replace(s,a.processed)}if(this.isEvaluableExpression(o))try{return this.evaluateMathExpression(o).toString()}catch(e){console.warn("Failed to evaluate mathematical expression:",e)}return o}isEvaluableExpression(e){return/^[\d+\-*/().\s]+$/.test(e.trim())&&/[+\-*/()]/.test(e)}evaluateMathExpression(e){let t=e.replace(/,/g,".");if(t=t.replace(/\s/g,""),console.log(`🧮 Evaluating math expression: "${e}" -> "${t}"`),!/^[0-9+\-*/().\s]+$/.test(t))throw new Error("Expression contains invalid characters");if((t.match(/\(/g)||[]).length!==(t.match(/\)/g)||[]).length)throw new Error("Unbalanced parentheses");const o=new Function("return "+t)();if("number"!=typeof o||isNaN(o)||!isFinite(o))throw new Error("Expression did not evaluate to a valid number");return o}async getFormulas(){if(this.formulasCache&&Date.now()-this.formulasCache.timestamp<this.formulasCache.ttl)return console.log("🚀 Using cached formulas (cache hit)"),this.formulasCache.formulas;console.log("📡 Fetching formulas from database...");const{data:e,error:t}=await a.supabase.from("formulas").select("*").eq("is_active",!0).order("name");if(t)throw new Error(`Failed to fetch formulas: ${t.message}`);return this.formulasCache={formulas:e||[],timestamp:Date.now(),ttl:3e5},console.log(`✅ Successfully fetched and cached ${e?.length||0} formulas`),e||[]}determineType(e){return e.includes("field:")?"field":e.includes("calc:")?"calculation":e.includes("lookup:")?"lookup":"static"}inferUnit(e){const t=e.toLowerCase();return t.includes("energiantarve")&&t.includes("kwh")?"kW":t.includes("öljyn menekki")?"L/vuosi":t.includes("kaasun menekki")?"MWh/vuosi":t.includes("puun menekki")?"motti/vuosi":""}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async _persistValue(){}async loadCachedValues(){try{const{data:e,error:t}=await a.supabase.from("processed_values").select("*").eq("session_id",this.context.sessionId).gte("updated_at",new Date(Date.now()-864e5).toISOString());if(t)return void console.error("Failed to load cached values:",t);if(e){for(const t of e){const e={id:t.value_id,type:t.type,raw:t.raw,processed:t.processed,dependencies:t.dependencies||[],timestamp:new Date(t.updated_at)},o=t.raw;this.cache.set(o,e)}console.log(`Loaded ${e.length} cached values from database`)}}catch(e){console.error("Error loading cached values:",e)}}getCacheStats(){return{size:this.cache.size,entries:Array.from(this.cache.keys())}}updateFormData(e){this.context.formData={...this.context.formData,...e}}}}}]);