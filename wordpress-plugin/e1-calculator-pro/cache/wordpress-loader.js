!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.E1Calculator=t():e.E1Calculator=t()}(this,function(){return e={},function(e,t){"use strict";if(e.E1CalculatorLoader)return e.E1CalculatorLoader;const n=5,i=200,o=5e3,a=!0,r=!0,s={performance:{},log(e,t,n=null){if(a){const i=(new Date).toISOString(),o=`[E1Calculator ${e.toUpperCase()}] ${i}`;n?console[e](o,t,n):console[e](o,t)}},info(e,t){this.log("info",e,t)},warn(e,t){this.log("warn",e,t)},error(e,t){this.log("error",e,t)},startTimer(e){this.performance[e]=performance.now()},endTimer(e){if(this.performance[e]){const t=performance.now()-this.performance[e];return this.info(`Performance: ${e} took ${t.toFixed(2)}ms`),delete this.performance[e],t}}},l={isDOMReady(){return"complete"===t.readyState||"interactive"===t.readyState},isWordPressReady(){const n=t.querySelector('script[src*="wp-includes"]')||t.querySelector('script[src*="wp-content"]'),i=void 0!==e.wp;return e.ajaxurl,!(n&&!i)},isjQueryReady(){return void 0===e.jQuery||"function"==typeof e.jQuery&&e.jQuery.fn},isBlockEditorReady(){return!(t.body.classList.contains("block-editor-page")||t.body.classList.contains("wp-admin"))||void 0!==e.wp&&void 0!==e.wp.blocks&&void 0!==e.wp.domReady},hasWidgetContainers(){return t.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]').length>0},isEnvironmentReady(){return{dom:this.isDOMReady(),wordpress:this.isWordPressReady(),jquery:this.isjQueryReady(),blockEditor:this.isBlockEditorReady(),containers:this.hasWidgetContainers()}}},c={calculateDelay(e){const t=i*Math.pow(2,e);return Math.min(t,o)},async withRetry(e,t="",i=n){let o;for(let n=0;n<i;n++)try{const i=await e(n);return n>0&&s.info(`${t} succeeded on attempt ${n+1}`),i}catch(e){if(o=e,n<i-1){const i=this.calculateDelay(n);s.warn(`${t} failed on attempt ${n+1}, retrying in ${i}ms`,e),await this.delay(i)}}throw s.error(`${t} failed after ${i} attempts`,o),o},delay(e){return new Promise(t=>setTimeout(t,e))}},d={createErrorElement(e,n,i=[]){const o=t.createElement("div");return o.className="e1-calculator-error",o.setAttribute("data-container-id",e),o.innerHTML=`\n        <div style="\n          padding: 20px;\n          margin: 10px 0;\n          background: linear-gradient(135deg, #fee 0%, #fef5e7 100%);\n          border: 1px solid #f5c6cb;\n          border-left: 4px solid #dc3545;\n          border-radius: 6px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          color: #721c24;\n        ">\n          <div style="display: flex; align-items: center; margin-bottom: 12px;">\n            <span style="font-size: 20px; margin-right: 8px;">‚ö†Ô∏è</span>\n            <strong style="font-size: 16px;">E1-laskurin lataus ep√§onnistui</strong>\n          </div>\n          \n          <p style="margin: 8px 0; line-height: 1.5;">\n            ${this.getErrorMessage(n)}\n          </p>\n          \n          ${i.length>0?`\n            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f5c6cb;">\n              <strong style="font-size: 14px; color: #856404;">üîß Vianm√§√§ritys:</strong>\n              <ul style="margin: 8px 0 0 20px; font-size: 14px; line-height: 1.4;">\n                ${i.map(e=>`<li style="margin: 4px 0;">${e}</li>`).join("")}\n              </ul>\n            </div>\n          `:""}\n          \n          <div style="margin-top: 16px; text-align: center;">\n            <button \n              onclick="window.E1Calculator?.retry?.('${e}')" \n              style="\n                background: #007cba;\n                color: white;\n                border: none;\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 14px;\n                margin-right: 8px;\n              "\n            >\n              üîÑ Yrit√§ uudelleen\n            </button>\n            <button \n              onclick="this.parentElement.parentElement.style.display='none'" \n              style="\n                background: #6c757d;\n                color: white;\n                border: none;\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 14px;\n              "\n            >\n              ‚úï Piilota\n            </button>\n          </div>\n        </div>\n      `,o},getErrorMessage(e){return"string"==typeof e?e:"NetworkError"===e?.name||e?.message?.includes("fetch")?"Verkko-ongelma. Tarkista internetyhteytesi.":e?.message?.includes("config")?"Laskurin asetustiedostoja ei l√∂ytynyt. Ota yhteytt√§ sivuston yll√§pit√§j√§√§n.":e?.message?.includes("Shadow DOM")||e?.message?.includes("attachShadow")?"Selaimesi ei tue kaikkia ominaisuuksia. Laskuri yritt√§√§ k√§ynnisty√§ yhteensopivuustilassa.":"Odottamaton virhe tapahtui. Jos ongelma jatkuu, p√§ivit√§ sivu tai ota yhteytt√§ tukeen."},getTroubleshootingTips(e,t){const n=[];return t.dom||n.push("Sivu ei ole viel√§ latautunut kokonaan"),t.wordpress||n.push("WordPress-ymp√§rist√∂ ei ole valmis"),t.containers||n.push("Laskurin s√§il√∂elementti√§ ei l√∂ydy sivulta"),(e?.message?.includes("fetch")||e?.message?.includes("network"))&&(n.push("Tarkista internetyhteytesi"),n.push("Varmista ett√§ sivuston palvelin vastaa")),e?.message?.includes("config")&&(n.push("Varmista ett√§ laskuri on asennettu oikein"),n.push("Tarkista WordPress-pluginin asetukset")),n}},u={isSupported(){return"undefined"!=typeof Element&&"function"==typeof Element.prototype.attachShadow},shouldUseShadowDOM(e){if("false"===e.dataset.shadow)return!1;if(t.body.classList.contains("block-editor-page")||t.body.classList.contains("wp-admin")||t.querySelector(".block-editor"))return s.info("Block editor detected, using namespace fallback"),!1;if(!this.isSupported())return s.info("Shadow DOM not supported, using namespace fallback"),!1;const n=[".elementor",".divi-theme",".avada-theme","[data-elementor-type]",".vc_row"];for(const e of n)if(t.querySelector(e))return s.info(`Problematic theme/plugin detected (${e}), using namespace fallback`),!1;return!0}},h=new class{constructor(){this.instances=new Map,this.configCache=null,this.initPromise=null,this.performanceMetrics={},s.info("E1Calculator WordPress Loader initialized")}async waitForDependencies(){return s.startTimer("dependency-wait"),c.withRetry(async e=>{const t=l.isEnvironmentReady();s.info(`Dependency check attempt ${e+1}`,t);const n=["dom","wordpress","jquery","blockEditor"].filter(e=>!t[e]);if(n.length>0)throw new Error(`Dependencies not ready: ${n.join(", ")}`);if(!t.containers&&e<2)throw new Error("Widget containers not found yet");return s.endTimer("dependency-wait"),t},"Dependency waiting")}async loadConfig(e){if(this.configCache)return this.configCache;s.startTimer("config-load");const t=await c.withRetry(async t=>{const n=[()=>this.fetchConfig(e),()=>this.loadConfigWithjQuery(e),()=>this.loadConfigWithXHR(e)],i=n[Math.min(t,n.length-1)];return await i()},`Config loading from ${e}`);return this.configCache=t,s.endTimer("config-load"),t}async fetchConfig(e){const t=`?v=${Date.now()}&t=${Math.random()}`,n=await fetch(e+t,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"},credentials:"same-origin"});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.json();if(!i||"object"!=typeof i)throw new Error("Invalid configuration data received");return i}async loadConfigWithjQuery(t){if(void 0===e.jQuery)throw new Error("jQuery not available");return new Promise((n,i)=>{e.jQuery.ajax({url:t,type:"GET",dataType:"json",cache:!1,timeout:1e4,success:e=>{e&&"object"==typeof e?n(e):i(new Error("Invalid configuration data"))},error:(e,t,n)=>{i(new Error(`jQuery AJAX failed: ${t} - ${n}`))}})})}async loadConfigWithXHR(e){return new Promise((t,n)=>{const i=new XMLHttpRequest;i.open("GET",e+`?v=${Date.now()}`,!0),i.timeout=1e4,i.setRequestHeader("Accept","application/json"),i.onload=()=>{if(i.status>=200&&i.status<300)try{const e=JSON.parse(i.responseText);if(!e||"object"!=typeof e)return void n(new Error("Invalid configuration data"));t(e)}catch(e){n(new Error("Failed to parse configuration JSON"))}else n(new Error(`XHR failed: ${i.status} ${i.statusText}`))},i.onerror=()=>n(new Error("Network error during XHR")),i.ontimeout=()=>n(new Error("XHR timeout")),i.send()})}async initWidget(e){const{containerId:n,useShadowDOM:i="auto",configUrl:o="/wp-content/uploads/e1-calculator-cache/config.json"}=e;s.startTimer(`widget-init-${n}`);try{const e=t.getElementById(n);if(!e)throw new Error(`Container element #${n} not found in DOM`);if(this.instances.has(n))return s.info(`Widget ${n} already initialized, skipping`),this.instances.get(n);const a=e.querySelector(".e1-calculator-loading");a&&(a.style.display="none");const r=await this.loadConfig(o),l="auto"===i?u.shouldUseShadowDOM(e):Boolean(i);let c,d=null;l?({mountPoint:c,shadowRoot:d}=await this.initWithShadowDOM(e)):c=await this.initWithNamespace(e),await this.waitForMainWidget();const h={container:e,shadowRoot:d,mountPoint:c,instance:await this.renderWidget(c,r,{useShadowDOM:l,containerId:n}),config:r,isolationMode:l?"shadow-dom":"namespace"};return this.instances.set(n,h),e.dispatchEvent(new CustomEvent("e1-calculator-ready",{detail:{containerId:n,instance:h,isolationMode:h.isolationMode}})),s.endTimer(`widget-init-${n}`),s.info(`Widget ${n} initialized successfully with ${h.isolationMode}`),h}catch(e){throw s.error(`Failed to initialize widget ${n}`,e),await this.showErrorMessage(n,e),s.endTimer(`widget-init-${n}`),e}}async initWithShadowDOM(e){try{const n=e.attachShadow({mode:"open"}),i=await this.loadResetStyles(),o=t.createElement("style");o.textContent=i,n.appendChild(o),await this.loadWidgetStylesIntoShadow(n);const a=t.createElement("div");return a.className="widget-root",n.appendChild(a),{mountPoint:a,shadowRoot:n}}catch(e){throw s.warn("Shadow DOM initialization failed, falling back to namespace",e),e}}async initWithNamespace(e){await this.loadNamespacedStyles(),e.innerHTML="";const n=t.createElement("div");return n.className="e1-calculator-isolated-root widget-root",e.appendChild(n),n}async loadResetStyles(){return"\n        /* E1 Calculator Shadow DOM Reset */\n        :host {\n          all: initial;\n          display: block;\n          box-sizing: border-box;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;\n          font-size: 16px;\n          line-height: 1.5;\n          color: #1a1a1a;\n          contain: layout style paint;\n          isolation: isolate;\n          width: 100%;\n          min-height: 400px;\n        }\n        \n        *, *::before, *::after {\n          box-sizing: border-box;\n          margin: 0;\n          padding: 0;\n          border: 0;\n          font-size: 100%;\n          font: inherit;\n          vertical-align: baseline;\n        }\n        \n        .widget-root {\n          width: 100%;\n          height: 100%;\n          position: relative;\n          background: #ffffff;\n          border-radius: 8px;\n          overflow: hidden;\n          z-index: 1;\n        }\n      "}async loadWidgetStylesIntoShadow(e){try{const n="/wp-content/uploads/e1-calculator-cache/widget.css",i=await fetch(n),o=await i.text(),a=t.createElement("style");a.textContent=o,e.appendChild(a)}catch(e){s.warn("Failed to load widget styles into shadow DOM",e)}}async loadNamespacedStyles(){const e="e1-calculator-namespaced-styles";if(t.getElementById(e))return;const n=t.createElement("link");return n.id=e,n.rel="stylesheet",n.href="/wp-content/uploads/e1-calculator-cache/widget-namespaced.css",new Promise((e,i)=>{n.onload=e,n.onerror=i,t.head.appendChild(n)})}async waitForMainWidget(){return c.withRetry(async t=>{if(void 0===e.E1Calculator||void 0===e.E1Calculator.init)throw new Error("Main E1Calculator widget not loaded");return!0},"Main widget loading",3)}async renderWidget(t,n,i){if(e.E1Calculator&&e.E1Calculator.init)return e.E1Calculator.init({container:t,config:n,...i});throw new Error("Main E1Calculator widget not available")}async showErrorMessage(e,n){if(!r)return;const i=t.getElementById(e);if(!i)return;const o=l.isEnvironmentReady(),a=d.getTroubleshootingTips(n,o),s=d.createErrorElement(e,n,a);i.innerHTML="",i.appendChild(s)}async init(e={}){return"string"==typeof e&&(e={containerId:e}),await this.waitForDependencies(),this.initWidget(e)}async initAll(){try{await this.waitForDependencies();const e=t.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]');if(0===e.length)return s.info("No E1Calculator containers found on page"),[];s.info(`Found ${e.length} E1Calculator containers`);const n=Array.from(e).map(e=>{const t={containerId:e.id||`e1-calc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,useShadowDOM:e.dataset.shadow||"auto",configUrl:e.dataset.configUrl};return e.id||(e.id=t.containerId),this.init(t).catch(e=>(s.error(`Failed to initialize container ${t.containerId}`,e),null))}),i=(await Promise.all(n)).filter(e=>null!==e);return s.info(`Successfully initialized ${i.length}/${e.length} widgets`),i}catch(e){throw s.error("Failed to initialize widgets",e),e}}async retry(e){s.info(`Retrying widget initialization for ${e}`),this.configCache=null,this.instances.has(e)&&this.destroy(e);const n=t.getElementById(e);return n&&(n.innerHTML='<div class="e1-calculator-loading"><p>Yritet√§√§n uudelleen...</p></div>'),this.init({containerId:e})}destroy(e){const t=this.instances.get(e);if(t)try{t.instance&&"function"==typeof t.instance.destroy&&t.instance.destroy(),t.shadowRoot?t.shadowRoot.innerHTML="":t.container.innerHTML="",this.instances.delete(e),s.info(`Widget ${e} destroyed`)}catch(t){s.error(`Failed to destroy widget ${e}`,t)}}destroyAll(){Array.from(this.instances.keys()).forEach(e=>this.destroy(e));const e=t.getElementById("e1-calculator-namespaced-styles");e&&e.remove(),s.info("All widgets destroyed")}getInstances(){return new Map(this.instances)}getPerformanceMetrics(){return{...this.performanceMetrics}}};e.E1Calculator=e.E1Calculator||{},Object.assign(e.E1Calculator,{init:e=>h.init(e),initAll:()=>h.initAll(),retry:e=>h.retry(e),destroy:e=>h.destroy(e),destroyAll:()=>h.destroyAll(),instances:()=>h.getInstances(),performance:()=>h.getPerformanceMetrics(),isReady:()=>l.isEnvironmentReady(),supportsShadowDOM:()=>u.isSupported()}),e.E1CalculatorLoader=h,async function(){try{await h.waitForDependencies();const e=t.querySelectorAll('[data-e1-auto-init="true"]');e.length>0&&(s.info(`Auto-initializing ${e.length} widgets`),await h.initAll())}catch(e){s.error("Auto-initialization failed",e)}}(),void 0!==e.wp&&e.wp.domReady&&e.wp.domReady(()=>{setTimeout(()=>{const e=t.querySelector(".block-editor-writing-flow")||t.querySelector(".edit-post-visual-editor")||t.body;e&&(new MutationObserver(e=>{let t=!1;e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]').length>0&&(t=!0)})}),t&&(s.info("New widgets detected in block editor, initializing..."),h.initAll().catch(e=>{s.error("Failed to initialize new widgets in block editor",e)}))}).observe(e,{childList:!0,subtree:!0}),s.info("Block editor observer initialized"))},1e3)})}(window,document),e=e.default;var e});