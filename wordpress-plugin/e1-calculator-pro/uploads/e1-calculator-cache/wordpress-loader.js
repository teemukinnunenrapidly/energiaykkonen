!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.E1CalculatorLoaderLib=t():e.E1CalculatorLoaderLib=t()}(this,function(){return function(e,t){"use strict";if(e.E1CalculatorLoader)return e.E1CalculatorLoader;const n=(e.e1_widget_config||{}).settings||{},i=n.debug_mode?5:3,o=200,a=5e3,r=n.debug_mode||!1,s=!0,l=(n.shadow_dom_mode,n.debug_mode,{performance:{},log(e,t,n=null){if(r){const i=(new Date).toISOString(),o=`[E1Calculator ${e.toUpperCase()}] ${i}`;n?console[e](o,t,n):console[e](o,t)}},info(e,t){this.log("info",e,t)},warn(e,t){this.log("warn",e,t)},error(e,t){this.log("error",e,t)},startTimer(e){this.performance[e]=performance.now()},endTimer(e){if(this.performance[e]){const t=performance.now()-this.performance[e];return this.info(`Performance: ${e} took ${t.toFixed(2)}ms`),delete this.performance[e],t}}}),c={isDOMReady(){return"complete"===t.readyState||"interactive"===t.readyState},isWordPressReady(){const n=t.body.classList.contains("wp-admin")||t.body.classList.contains("block-editor-page")||!!t.querySelector(".block-editor"),i=void 0!==e.wp;return!(n&&!i)},isjQueryReady(){return void 0===e.jQuery||"function"==typeof e.jQuery&&e.jQuery.fn},isBlockEditorReady(){return!(t.body.classList.contains("block-editor-page")||t.body.classList.contains("wp-admin"))||void 0!==e.wp&&void 0!==e.wp.blocks&&void 0!==e.wp.domReady},hasWidgetContainers(){return t.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]').length>0},isEnvironmentReady(){return{dom:this.isDOMReady(),wordpress:this.isWordPressReady(),jquery:this.isjQueryReady(),blockEditor:this.isBlockEditorReady(),containers:this.hasWidgetContainers()}}},d={calculateDelay(e){const t=o*Math.pow(2,e);return Math.min(t,a)},async withRetry(e,t="",n=i){let o;for(let i=0;i<n;i++)try{const n=await e(i);return i>0&&l.info(`${t} succeeded on attempt ${i+1}`),n}catch(e){if(o=e,i<n-1){const n=this.calculateDelay(i);l.warn(`${t} failed on attempt ${i+1}, retrying in ${n}ms`,e),await this.delay(n)}}throw l.error(`${t} failed after ${n} attempts`,o),o},delay(e){return new Promise(t=>setTimeout(t,e))}},u={createErrorElement(e,n,i=[]){const o=t.createElement("div");return o.className="e1-calculator-error",o.setAttribute("data-container-id",e),o.innerHTML=`\n        <div style="\n          padding: 20px;\n          margin: 10px 0;\n          background: linear-gradient(135deg, #fee 0%, #fef5e7 100%);\n          border: 1px solid #f5c6cb;\n          border-left: 4px solid #dc3545;\n          border-radius: 6px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          color: #721c24;\n        ">\n          <div style="display: flex; align-items: center; margin-bottom: 12px;">\n            <span style="font-size: 20px; margin-right: 8px;">‚ö†Ô∏è</span>\n            <strong style="font-size: 16px;">E1-laskurin lataus ep√§onnistui</strong>\n          </div>\n          \n          <p style="margin: 8px 0; line-height: 1.5;">\n            ${this.getErrorMessage(n)}\n          </p>\n          \n          ${i.length>0?`\n            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f5c6cb;">\n              <strong style="font-size: 14px; color: #856404;">üîß Vianm√§√§ritys:</strong>\n              <ul style="margin: 8px 0 0 20px; font-size: 14px; line-height: 1.4;">\n                ${i.map(e=>`<li style="margin: 4px 0;">${e}</li>`).join("")}\n              </ul>\n            </div>\n          `:""}\n          \n          <div style="margin-top: 16px; text-align: center;">\n            <button \n              onclick="window.E1Calculator?.retry?.('${e}')" \n              style="\n                background: #007cba;\n                color: white;\n                border: none;\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 14px;\n                margin-right: 8px;\n              "\n            >\n              üîÑ Yrit√§ uudelleen\n            </button>\n            <button \n              onclick="this.parentElement.parentElement.style.display='none'" \n              style="\n                background: #6c757d;\n                color: white;\n                border: none;\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 14px;\n              "\n            >\n              ‚úï Piilota\n            </button>\n          </div>\n        </div>\n      `,o},getErrorMessage(e){return"string"==typeof e?e:"NetworkError"===e?.name||e?.message?.includes("fetch")?"Verkko-ongelma. Tarkista internetyhteytesi.":e?.message?.includes("config")?"Laskurin asetustiedostoja ei l√∂ytynyt. Ota yhteytt√§ sivuston yll√§pit√§j√§√§n.":e?.message?.includes("Shadow DOM")||e?.message?.includes("attachShadow")?"Selaimesi ei tue kaikkia ominaisuuksia. Laskuri yritt√§√§ k√§ynnisty√§ yhteensopivuustilassa.":"Odottamaton virhe tapahtui. Jos ongelma jatkuu, p√§ivit√§ sivu tai ota yhteytt√§ tukeen."},getTroubleshootingTips(e,t){const n=[];return t.dom||n.push("Sivu ei ole viel√§ latautunut kokonaan"),t.wordpress||n.push("WordPress-ymp√§rist√∂ ei ole valmis"),t.containers||n.push("Laskurin s√§il√∂elementti√§ ei l√∂ydy sivulta"),(e?.message?.includes("fetch")||e?.message?.includes("network"))&&(n.push("Tarkista internetyhteytesi"),n.push("Varmista ett√§ sivuston palvelin vastaa")),e?.message?.includes("config")&&(n.push("Varmista ett√§ laskuri on asennettu oikein"),n.push("Tarkista WordPress-pluginin asetukset")),n}},h={isSupported(){return"undefined"!=typeof Element&&"function"==typeof Element.prototype.attachShadow},shouldUseShadowDOM(e){if("false"===e.dataset.shadow)return!1;if(t.body.classList.contains("block-editor-page")||t.body.classList.contains("wp-admin")||t.querySelector(".block-editor"))return l.info("Block editor detected, using namespace fallback"),!1;if(!this.isSupported())return l.info("Shadow DOM not supported, using namespace fallback"),!1;const n=[".elementor",".divi-theme",".avada-theme","[data-elementor-type]",".vc_row"];for(const e of n)if(t.querySelector(e))return l.info(`Problematic theme/plugin detected (${e}), using namespace fallback`),!1;return!0}},p=new class{constructor(){this.instances=new Map,this.configCache=null,this.initPromise=null,this.performanceMetrics={},l.info("E1Calculator WordPress Loader initialized")}async waitForDependencies(){return l.startTimer("dependency-wait"),d.withRetry(async e=>{const t=c.isEnvironmentReady();l.info(`Dependency check attempt ${e+1}`,t);const n=["dom","wordpress","jquery","blockEditor"].filter(e=>!t[e]);if(n.length>0)throw new Error(`Dependencies not ready: ${n.join(", ")}`);if(!t.containers&&e<2)throw new Error("Widget containers not found yet");return l.endTimer("dependency-wait"),t},"Dependency waiting")}async loadConfig(e){if(this.configCache)return this.configCache;l.startTimer("config-load");const t=await d.withRetry(async t=>{const n=[()=>this.fetchConfig(e),()=>this.loadConfigWithjQuery(e),()=>this.loadConfigWithXHR(e)],i=n[Math.min(t,n.length-1)];return await i()},`Config loading from ${e}`);return this.configCache=t,l.endTimer("config-load"),t}async fetchConfig(e){const t=`?v=${Date.now()}&t=${Math.random()}`,n=await fetch(e+t,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"},credentials:"same-origin"});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.json();if(!i||"object"!=typeof i)throw new Error("Invalid configuration data received");return i}async loadConfigWithjQuery(t){if(void 0===e.jQuery)throw new Error("jQuery not available");return new Promise((n,i)=>{e.jQuery.ajax({url:t,type:"GET",dataType:"json",cache:!1,timeout:1e4,success:e=>{e&&"object"==typeof e?n(e):i(new Error("Invalid configuration data"))},error:(e,t,n)=>{i(new Error(`jQuery AJAX failed: ${t} - ${n}`))}})})}async loadConfigWithXHR(e){return new Promise((t,n)=>{const i=new XMLHttpRequest;i.open("GET",e+`?v=${Date.now()}`,!0),i.timeout=1e4,i.setRequestHeader("Accept","application/json"),i.onload=()=>{if(i.status>=200&&i.status<300)try{const e=JSON.parse(i.responseText);if(!e||"object"!=typeof e)return void n(new Error("Invalid configuration data"));t(e)}catch(e){n(new Error("Failed to parse configuration JSON"))}else n(new Error(`XHR failed: ${i.status} ${i.statusText}`))},i.onerror=()=>n(new Error("Network error during XHR")),i.ontimeout=()=>n(new Error("XHR timeout")),i.send()})}async initWidget(e){const{containerId:n,useShadowDOM:i="auto",configUrl:o="/wp-content/uploads/e1-calculator-cache/config.json",apiUrl:a}=e;l.startTimer(`widget-init-${n}`);try{const e=t.getElementById(n);if(!e)throw new Error(`Container element #${n} not found in DOM`);try{e.classList.add("e1-no-focus-outline"),e.style.outline="none",e.style.boxShadow="none";const n="e1-global-no-outline";if(!t.getElementById(n)){const e=t.createElement("style");e.id=n,e.textContent="\n              .e1-no-focus-outline:focus,\n              .e1-no-focus-outline:focus-visible,\n              .e1-no-focus-outline:focus-within { outline: none !important; box-shadow: none !important; }\n            ",t.head.appendChild(e)}}catch(e){}if(this.instances.has(n))return l.info(`Widget ${n} already initialized, skipping`),this.instances.get(n);const r=e.querySelector(".e1-calculator-loading");r&&(r.style.display="none");const s=await this.loadConfig(o),c="auto"===i?h.shouldUseShadowDOM(e):Boolean(i);let d,u=null;c?({mountPoint:d,shadowRoot:u}=await this.initWithShadowDOM(e)):d=await this.initWithNamespace(e),await this.waitForMainWidget();const p={container:e,shadowRoot:u,mountPoint:d,instance:await this.renderWidget(d,s,{useShadowDOM:c,containerId:n,apiUrl:a}),config:s,isolationMode:c?"shadow-dom":"namespace"};return this.instances.set(n,p),e.dispatchEvent(new CustomEvent("e1-calculator-ready",{detail:{containerId:n,instance:p,isolationMode:p.isolationMode}})),l.endTimer(`widget-init-${n}`),l.info(`Widget ${n} initialized successfully with ${p.isolationMode}`),p}catch(e){throw l.error(`Failed to initialize widget ${n}`,e),await this.showErrorMessage(n,e),l.endTimer(`widget-init-${n}`),e}}async initWithShadowDOM(e){try{const n=e.attachShadow({mode:"open"}),i=await this.loadResetStyles(),o=t.createElement("style");o.textContent=i,n.appendChild(o),await this.loadWidgetStylesIntoShadow(n);const a=t.createElement("div");return a.className="widget-root",n.appendChild(a),{mountPoint:a,shadowRoot:n}}catch(e){throw l.warn("Shadow DOM initialization failed, falling back to namespace",e),e}}async initWithNamespace(e){await this.loadNamespacedStyles(),e.innerHTML="";const n=t.createElement("div");return n.className="e1-calculator-isolated-root widget-root",e.appendChild(n),n}async loadResetStyles(){return"\n        /* E1 Calculator Shadow DOM Reset */\n        :host {\n          /* Do NOT reset 'all' so CSS variables from the host/page cascade in */\n          display: block;\n          box-sizing: border-box;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;\n          font-size: 16px;\n          line-height: 1.5;\n          color: #1a1a1a;\n          /* Avoid layout containment so position: sticky works across ancestors */\n          contain: paint style;\n          isolation: isolate;\n          width: 100%;\n          min-height: 400px;\n        }\n        \n        *, *::before, *::after {\n          box-sizing: border-box;\n          margin: 0;\n          padding: 0;\n          border: 0;\n          font-size: 100%;\n          font: inherit;\n          vertical-align: baseline;\n        }\n        \n        .widget-root {\n          width: 100%;\n          height: 100%;\n          position: relative;\n          background: #ffffff;\n          border-radius: 8px;\n          /* Allow sticky descendants to track viewport/window scroll */\n          overflow: visible;\n          z-index: 1;\n        }\n      "}async loadWidgetStylesIntoShadow(e){try{const n="/wp-content/uploads/e1-calculator-cache/widget.css",i=await fetch(n),o=await i.text(),a=t.createElement("style");a.textContent=o,e.appendChild(a)}catch(e){l.warn("Failed to load widget styles into shadow DOM",e)}}async loadNamespacedStyles(){const e="e1-calculator-namespaced-styles";if(t.getElementById(e))return;const n=t.createElement("link");return n.id=e,n.rel="stylesheet",n.href="/wp-content/uploads/e1-calculator-cache/widget-namespaced.css",new Promise((e,i)=>{n.onload=e,n.onerror=i,t.head.appendChild(n)})}async waitForMainWidget(){return d.withRetry(async t=>{if(void 0===e.E1CalculatorWidget||void 0===e.E1CalculatorWidget.init)throw new Error("Main E1Calculator widget not loaded");return!0},"Main widget loading",3)}async renderWidget(t,n,i){if(e.E1CalculatorWidget&&e.E1CalculatorWidget.init)return e.E1CalculatorWidget.init({container:t,config:n,...i});throw new Error("Main E1Calculator widget not available")}async showErrorMessage(e,n){if(!s)return;const i=t.getElementById(e);if(!i)return;const o=c.isEnvironmentReady(),a=u.getTroubleshootingTips(n,o),r=u.createErrorElement(e,n,a);i.innerHTML="",i.appendChild(r)}async init(e={}){return"string"==typeof e&&(e={containerId:e}),await this.waitForDependencies(),this.initWidget(e)}async initAll(){try{await this.waitForDependencies();const e=t.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]');if(0===e.length)return l.info("No E1Calculator containers found on page"),[];l.info(`Found ${e.length} E1Calculator containers`);const n=Array.from(e).map(e=>{const t={containerId:e.id||`e1-calc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,useShadowDOM:e.dataset.shadow||"auto",configUrl:e.dataset.configUrl,apiUrl:e.dataset.apiUrl};return e.id||(e.id=t.containerId),this.init(t).catch(e=>(l.error(`Failed to initialize container ${t.containerId}`,e),null))}),i=(await Promise.all(n)).filter(e=>null!==e);return l.info(`Successfully initialized ${i.length}/${e.length} widgets`),i}catch(e){throw l.error("Failed to initialize widgets",e),e}}async retry(e){l.info(`Retrying widget initialization for ${e}`),this.configCache=null,this.instances.has(e)&&this.destroy(e);const n=t.getElementById(e);return n&&(n.innerHTML='<div class="e1-calculator-loading"><p>Yritet√§√§n uudelleen...</p></div>'),this.init({containerId:e})}destroy(e){const t=this.instances.get(e);if(t)try{t.instance&&"function"==typeof t.instance.destroy&&t.instance.destroy(),t.shadowRoot?t.shadowRoot.innerHTML="":t.container.innerHTML="",this.instances.delete(e),l.info(`Widget ${e} destroyed`)}catch(t){l.error(`Failed to destroy widget ${e}`,t)}}destroyAll(){Array.from(this.instances.keys()).forEach(e=>this.destroy(e));const e=t.getElementById("e1-calculator-namespaced-styles");e&&e.remove(),l.info("All widgets destroyed")}getInstances(){return new Map(this.instances)}getPerformanceMetrics(){return{...this.performanceMetrics}}};e.E1Calculator=e.E1Calculator||{},Object.assign(e.E1Calculator,{init:e=>p.init(e),initAll:()=>p.initAll(),retry:e=>p.retry(e),destroy:e=>p.destroy(e),destroyAll:()=>p.destroyAll(),instances:()=>p.getInstances(),performance:()=>p.getPerformanceMetrics(),isReady:()=>c.isEnvironmentReady(),supportsShadowDOM:()=>h.isSupported()}),e.E1CalculatorLoader=p,async function(){try{await p.waitForDependencies();const e=t.querySelectorAll('[data-e1-auto-init="true"]');e.length>0&&(l.info(`Auto-initializing ${e.length} widgets`),await p.initAll())}catch(e){l.error("Auto-initialization failed",e)}}(),void 0!==e.wp&&e.wp.domReady&&e.wp.domReady(()=>{setTimeout(()=>{const e=t.querySelector(".block-editor-writing-flow")||t.querySelector(".edit-post-visual-editor")||t.body;e&&(new MutationObserver(e=>{let t=!1;e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.querySelectorAll('[id^="e1-calculator-widget"], [class*="e1-calculator-container"]').length>0&&(t=!0)})}),t&&(l.info("New widgets detected in block editor, initializing..."),p.initAll().catch(e=>{l.error("Failed to initialize new widgets in block editor",e)}))}).observe(e,{childList:!0,subtree:!0}),l.info("Block editor observer initialized"))},1e3)})}(window,document),{}});