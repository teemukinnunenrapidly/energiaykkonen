<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Multiple Instances Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; }
        .wp-content { max-width: 1200px; margin: 0 auto; }
        .widget-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .widget-container { padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .widget-info { background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 14px; }
        @media (max-width: 768px) {
            .widget-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="wp-content">
        <h1>WordPress Multiple Widget Instances Test</h1>
        <p>This page tests multiple E1 Calculator widgets with different configurations on the same page.</p>
        
        <div class="widget-grid">
            <div class="widget-container">
                <div class="widget-info">
                    <strong>Widget 1:</strong> Shadow DOM, Default Theme, 500px
                </div>
                <div id="multi-widget-1" data-e1-calculator data-shadow="true" data-theme="default" data-height="500px">
                    <!-- Widget 1 -->
                </div>
            </div>
            
            <div class="widget-container">
                <div class="widget-info">
                    <strong>Widget 2:</strong> Namespace, Light Theme, 450px
                </div>
                <div id="multi-widget-2" data-e1-calculator data-shadow="false" data-theme="light" data-height="450px">
                    <!-- Widget 2 -->
                </div>
            </div>
            
            <div class="widget-container">
                <div class="widget-info">
                    <strong>Widget 3:</strong> Shadow DOM, Dark Theme, 600px
                </div>
                <div id="multi-widget-3" data-e1-calculator data-shadow="true" data-theme="dark" data-height="600px">
                    <!-- Widget 3 -->
                </div>
            </div>
            
            <div class="widget-container">
                <div class="widget-info">
                    <strong>Widget 4:</strong> Namespace, Energiaykkonen Theme, 400px
                </div>
                <div id="multi-widget-4" data-e1-calculator data-shadow="false" data-theme="energiaykkonen" data-height="400px">
                    <!-- Widget 4 -->
                </div>
            </div>
        </div>
        
        <div class="widget-container" style="grid-column: 1 / -1;">
            <div class="widget-info">
                <strong>Widget 5:</strong> Full width, Shadow DOM, Custom configuration
            </div>
            <div id="multi-widget-5" 
                 data-e1-calculator 
                 data-shadow="true" 
                 data-theme="default"
                 data-show-visual-support="true"
                 data-enable-cache="true"
                 data-height="500px"
                 data-mobile-height="400px">
                <!-- Widget 5 -->
            </div>
        </div>
        
        <h2>Instance Management Test</h2>
        <div style="margin: 20px 0;">
            <button onclick="testDestroy()" style="margin: 5px; padding: 10px;">Destroy Widget 2</button>
            <button onclick="testRecreate()" style="margin: 5px; padding: 10px;">Recreate Widget 2</button>
            <button onclick="testDestroyAll()" style="margin: 5px; padding: 10px;">Destroy All</button>
            <button onclick="testRecreateAll()" style="margin: 5px; padding: 10px;">Recreate All</button>
        </div>
        
        <h2>Test Results</h2>
        <div id="test-results" style="padding: 20px; border: 1px solid #ccc; border-radius: 4px;">
            <h3>Loading...</h3>
        </div>
    </div>
    
    <script>
        window.e1CalculatorWP = {
            ajaxUrl: '/wp-admin/admin-ajax.php',
            nonce: 'multi-instance-nonce',
            configNonce: 'config-nonce',
            cacheUrl: '../../dist',
            version: '2.2.0'
        };
    </script>
    
    <script src="../../dist/e1-calculator-widget.min.js"></script>
    <script>
        let allInstances = [];
        
        async function testMultipleInstances() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Testing Multiple Widget Instances...</h3>';
            
            try {
                // Initialize all widgets
                allInstances = await window.E1Calculator.initAll();
                
                let report = '<h3>Multiple Instances Test Results</h3>';
                report += `<p>‚úÖ Total widgets initialized: ${allInstances.length}</p>`;
                
                // Test different modes
                const shadowWidgets = allInstances.filter(w => w && w.mode === 'shadow');
                const namespaceWidgets = allInstances.filter(w => w && w.mode === 'namespace');
                
                report += `<p>üìä Shadow DOM widgets: ${shadowWidgets.length}</p>`;
                report += `<p>üìä Namespace widgets: ${namespaceWidgets.length}</p>`;
                
                // Test unique IDs
                const ids = allInstances.map(w => w ? w.elementId : null).filter(Boolean);
                const uniqueIds = new Set(ids);
                
                if (ids.length === uniqueIds.size) {
                    report += '<p>‚úÖ All widget IDs are unique</p>';
                } else {
                    report += '<p>‚ùå Duplicate widget IDs detected</p>';
                }
                
                // Test isolation between widgets
                let isolationTest = true;
                allInstances.forEach((widget, index) => {
                    if (widget) {
                        const container = document.getElementById(widget.elementId);
                        if (!container) {
                            isolationTest = false;
                        }
                    }
                });
                
                if (isolationTest) {
                    report += '<p>‚úÖ Widget isolation working correctly</p>';
                } else {
                    report += '<p>‚ùå Widget isolation issues detected</p>';
                }
                
                // Test performance impact
                const loadTime = performance.now() - window.startTime;
                report += `<p>‚ö° Total load time: ${Math.round(loadTime)}ms</p>`;
                report += `<p>‚ö° Average per widget: ${Math.round(loadTime / allInstances.length)}ms</p>`;
                
                results.innerHTML = report;
                
            } catch (error) {
                results.innerHTML = '<h3>Test Failed</h3><p>' + error.message + '</p>';
            }
        }
        
        function testDestroy() {
            if (window.E1Calculator.destroy('multi-widget-2')) {
                updateResults('Widget 2 destroyed successfully');
            } else {
                updateResults('Widget 2 destruction failed');
            }
        }
        
        async function testRecreate() {
            const instance = await window.E1Calculator.init('multi-widget-2', {
                useShadowDOM: false,
                theme: 'light'
            });
            
            if (instance) {
                updateResults('Widget 2 recreated successfully');
            } else {
                updateResults('Widget 2 recreation failed');
            }
        }
        
        function testDestroyAll() {
            const destroyed = window.E1Calculator.destroyAll();
            updateResults(`All widgets destroyed: ${destroyed.length} instances`);
        }
        
        async function testRecreateAll() {
            const instances = await window.E1Calculator.initAll();
            updateResults(`All widgets recreated: ${instances.length} instances`);
        }
        
        function updateResults(message) {
            const results = document.getElementById('test-results');
            const currentTime = new Date().toLocaleTimeString();
            results.innerHTML += `<p>[${currentTime}] ${message}</p>`;
        }
        
        // Track initial load time
        window.startTime = performance.now();
        window.addEventListener('load', testMultipleInstances);
    </script>
</body>
</html>