<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rendering Performance Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .performance-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric { background: #e8f5e8; border: 1px solid #a4d4a4; border-radius: 4px; padding: 15px; text-align: center; }
        .metric h4 { margin: 0 0 10px 0; color: #2e7d32; }
        .metric .value { font-size: 24px; font-weight: bold; }
        .test-area { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; margin: 20px 0; min-height: 300px; }
        .controls button { margin: 5px; padding: 10px 15px; border: none; background: #4caf50; color: white; border-radius: 4px; cursor: pointer; }
        .fps-counter { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>E1 Calculator Rendering Performance Test</h1>
    
    <div class="fps-counter" id="fps-counter">FPS: --</div>
    
    <div class="performance-metrics" id="metrics">
        <div class="metric">
            <h4>Initial Render</h4>
            <div class="value" id="initial-render">--ms</div>
        </div>
        <div class="metric">
            <h4>Layout Recalc</h4>
            <div class="value" id="layout-recalc">--ms</div>
        </div>
        <div class="metric">
            <h4>Paint Time</h4>
            <div class="value" id="paint-time">--ms</div>
        </div>
        <div class="metric">
            <h4>Composite Time</h4>
            <div class="value" id="composite-time">--ms</div>
        </div>
        <div class="metric">
            <h4>Frame Drops</h4>
            <div class="value" id="frame-drops">0</div>
        </div>
        <div class="metric">
            <h4>Smooth Animation</h4>
            <div class="value" id="smooth-animation">--</div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="testInitialRender()">Test Initial Render</button>
        <button onclick="testReflowPerformance()">Test Reflow</button>
        <button onclick="testRepaintPerformance()">Test Repaint</button>
        <button onclick="testAnimationPerformance()">Test Animation</button>
        <button onclick="testScrollPerformance()">Test Scroll</button>
        <button onclick="startFPSMonitor()">Start FPS Monitor</button>
        <button onclick="stopFPSMonitor()">Stop FPS Monitor</button>
    </div>
    
    <div class="test-area" id="test-area">
        <h3>Rendering Test Area</h3>
        <div id="render-test-widgets">
            <!-- Widgets will be rendered here for testing -->
        </div>
    </div>
    
    <div id="performance-log" style="background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
    
    <script src="../../dist/e1-calculator-widget.min.js"></script>
    <script>
        let fpsMonitor = null;
        let performanceMetrics = {
            frameCount: 0,
            lastTime: performance.now(),
            frameDrops: 0
        };
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('performance-log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateMetric(id, value, unit = '') {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value + unit;
            }
        }
        
        async function testInitialRender() {
            log('Testing initial render performance...');
            
            const container = document.getElementById('render-test-widgets');
            container.innerHTML = ''; // Clear existing widgets
            
            // Create widget container
            const widgetDiv = document.createElement('div');
            widgetDiv.id = 'render-performance-test';
            widgetDiv.setAttribute('data-e1-calculator', '');
            container.appendChild(widgetDiv);
            
            // Measure render time
            const renderStart = performance.now();
            
            try {
                // Use Performance Observer to measure paint timing
                const paintObserver = new PerformanceObserver((list) => {
                    const entries = list.getEntries();
                    for (const entry of entries) {
                        if (entry.name === 'first-paint') {
                            updateMetric('paint-time', Math.round(entry.startTime), 'ms');
                        } else if (entry.name === 'first-contentful-paint') {
                            updateMetric('composite-time', Math.round(entry.startTime), 'ms');
                        }
                    }
                });
                paintObserver.observe({ entryTypes: ['paint'] });
                
                // Initialize widget and measure time
                const instance = await window.E1Calculator.init('render-performance-test');
                const renderEnd = performance.now();
                const renderTime = renderEnd - renderStart;
                
                updateMetric('initial-render', Math.round(renderTime), 'ms');
                log(`Initial render completed in ${Math.round(renderTime)}ms`);
                
                // Measure layout recalculation
                const layoutStart = performance.now();
                widgetDiv.style.display = 'none';
                widgetDiv.offsetHeight; // Force reflow
                widgetDiv.style.display = 'block';
                const layoutEnd = performance.now();
                
                updateMetric('layout-recalc', Math.round(layoutEnd - layoutStart), 'ms');
                
                setTimeout(() => paintObserver.disconnect(), 1000);
                
            } catch (error) {
                log('Initial render test failed: ' + error.message);
            }
        }
        
        function testReflowPerformance() {
            log('Testing reflow performance...');
            
            const testElement = document.getElementById('render-test-widgets');
            const reflowStart = performance.now();
            
            // Trigger multiple reflows
            for (let i = 0; i < 10; i++) {
                testElement.style.width = (300 + i * 10) + 'px';
                testElement.offsetWidth; // Force reflow
            }
            
            const reflowEnd = performance.now();
            const reflowTime = reflowEnd - reflowStart;
            
            updateMetric('layout-recalc', Math.round(reflowTime), 'ms');
            log(`Reflow performance test: ${Math.round(reflowTime)}ms for 10 reflows`);
            
            // Reset width
            testElement.style.width = '';
        }
        
        function testRepaintPerformance() {
            log('Testing repaint performance...');
            
            const testElement = document.getElementById('render-test-widgets');
            const repaintStart = performance.now();
            
            // Trigger multiple repaints
            for (let i = 0; i < 10; i++) {
                testElement.style.backgroundColor = `hsl(${i * 36}, 50%, 80%)`;
            }
            
            const repaintEnd = performance.now();
            const repaintTime = repaintEnd - repaintStart;
            
            updateMetric('paint-time', Math.round(repaintTime), 'ms');
            log(`Repaint performance test: ${Math.round(repaintTime)}ms for 10 repaints`);
            
            // Reset background
            testElement.style.backgroundColor = '';
        }
        
        function testAnimationPerformance() {
            log('Testing animation performance...');
            
            const testElement = document.getElementById('render-test-widgets');
            let frameCount = 0;
            let droppedFrames = 0;
            let lastFrameTime = performance.now();
            const targetFPS = 60;
            const frameDuration = 1000 / targetFPS;
            
            // Add animation
            testElement.style.transition = 'transform 2s ease-in-out';
            testElement.style.transform = 'translateX(200px) rotate(180deg) scale(1.2)';
            
            function measureFrame() {
                const currentTime = performance.now();
                const deltaTime = currentTime - lastFrameTime;
                
                frameCount++;
                
                if (deltaTime > frameDuration * 1.5) {
                    droppedFrames++;
                }
                
                lastFrameTime = currentTime;
                
                if (frameCount < 120) { // Monitor for 2 seconds at 60fps
                    requestAnimationFrame(measureFrame);
                } else {
                    // Animation complete, calculate results
                    const actualFPS = Math.round(frameCount / 2); // 2 seconds
                    const frameDropPercentage = Math.round((droppedFrames / frameCount) * 100);
                    
                    updateMetric('frame-drops', droppedFrames);
                    updateMetric('smooth-animation', frameDropPercentage < 5 ? '✅ Yes' : '❌ No');
                    
                    log(`Animation test: ${actualFPS}fps average, ${droppedFrames} dropped frames (${frameDropPercentage}%)`);
                    
                    // Reset transform
                    setTimeout(() => {
                        testElement.style.transition = '';
                        testElement.style.transform = '';
                    }, 100);
                }
            }
            
            requestAnimationFrame(measureFrame);
        }
        
        function testScrollPerformance() {
            log('Testing scroll performance...');
            
            // Create scrollable content
            const scrollContainer = document.createElement('div');
            scrollContainer.style.height = '200px';
            scrollContainer.style.overflow = 'auto';
            scrollContainer.style.border = '1px solid #ccc';
            
            const scrollContent = document.createElement('div');
            scrollContent.style.height = '2000px';
            scrollContent.style.background = 'linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet)';
            scrollContainer.appendChild(scrollContent);
            
            document.getElementById('test-area').appendChild(scrollContainer);
            
            let scrollFrameCount = 0;
            let scrollStartTime = performance.now();
            
            function measureScrollFrame() {
                scrollFrameCount++;
                
                if (scrollFrameCount < 60) { // 1 second of monitoring
                    scrollContainer.scrollTop += 10;
                    requestAnimationFrame(measureScrollFrame);
                } else {
                    const scrollEndTime = performance.now();
                    const scrollTime = scrollEndTime - scrollStartTime;
                    const scrollFPS = Math.round(scrollFrameCount / (scrollTime / 1000));
                    
                    log(`Scroll performance: ${scrollFPS}fps during scrolling`);
                    
                    // Clean up
                    scrollContainer.remove();
                }
            }
            
            requestAnimationFrame(measureScrollFrame);
        }
        
        function startFPSMonitor() {
            if (fpsMonitor) return;
            
            log('Starting FPS monitor...');
            let frameCount = 0;
            let lastTime = performance.now();
            
            fpsMonitor = setInterval(() => {
                const currentTime = performance.now();
                const deltaTime = currentTime - lastTime;
                const fps = Math.round(1000 / deltaTime);
                
                document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
                
                frameCount++;
                lastTime = currentTime;
                
            }, 1000 / 60); // 60 FPS monitoring
        }
        
        function stopFPSMonitor() {
            if (fpsMonitor) {
                clearInterval(fpsMonitor);
                fpsMonitor = null;
                document.getElementById('fps-counter').textContent = 'FPS: --';
                log('FPS monitor stopped');
            }
        }
        
        // Auto-start some tests
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded, ready for rendering performance tests');
                startFPSMonitor();
            }, 1000);
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopFPSMonitor();
        });
    </script>
</body>
</html>