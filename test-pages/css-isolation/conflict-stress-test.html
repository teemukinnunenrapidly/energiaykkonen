<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSS Conflict Stress Test</title>
    <style>
        /* Extreme conflicting styles for stress testing */
        * { 
            all: unset !important;
            display: block !important;
            background: linear-gradient(45deg, red, yellow, green, blue) !important;
            border: 20px dotted black !important;
            margin: 30px !important;
            padding: 40px !important;
            font-family: 'Courier New' !important;
            font-size: 30px !important;
            color: white !important;
            text-shadow: 2px 2px 4px black !important;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.8) !important;
        }
        
        .card, .button, input, select, textarea, h1, h2, h3, p, div {
            animation: rainbow 3s infinite !important;
        }
        
        @keyframes rainbow {
            0% { background: red !important; }
            16% { background: orange !important; }
            32% { background: yellow !important; }
            48% { background: green !important; }
            64% { background: blue !important; }
            80% { background: indigo !important; }
            100% { background: violet !important; }
        }
    </style>
</head>
<body>
    <div>
        <h1>CSS Conflict Stress Test</h1>
        <p>This page applies extreme CSS conflicts to test widget resilience.</p>
        
        <div class="card">
            <h2>External Card with Extreme Styles</h2>
            <p>This should have rainbow animation and extreme styling.</p>
        </div>
        
        <div id="stress-test-widget" data-e1-calculator style="border: 5px solid purple;">
            <!-- Widget should resist all external styling -->
        </div>
        
        <input type="text" placeholder="External input with extreme styles" />
        <button class="button">External Button with Extreme Styles</button>
        
        <div id="test-results">
            <h2>Stress Test Results</h2>
            <div id="results-content">Loading...</div>
        </div>
    </div>
    
    <script src="../../../dist/e1-calculator-widget.min.js"></script>
    <script>
        async function runStressTest() {
            const results = document.getElementById('results-content');
            results.innerHTML = 'Running stress test...';
            
            try {
                const widget = await window.E1Calculator.init('stress-test-widget');
                
                if (widget) {
                    let report = `<h3>Stress Test Results</h3>`;
                    report += `<p>‚úÖ Widget initialized in ${widget.mode} mode</p>`;
                    
                    // Check if widget resisted extreme styling
                    const container = document.getElementById('stress-test-widget');
                    let widgetElements;
                    
                    if (widget.mode === 'shadow' && container.shadowRoot) {
                        widgetElements = container.shadowRoot.querySelectorAll('*');
                    } else {
                        widgetElements = container.querySelectorAll('.e1-calculator-isolated-root *');
                    }
                    
                    if (widgetElements.length > 0) {
                        report += `<p>üìä Found ${widgetElements.length} widget elements</p>`;
                        
                        // Check if any widget elements have the rainbow animation
                        let affectedElements = 0;
                        Array.from(widgetElements).forEach(el => {
                            const style = getComputedStyle(el);
                            if (style.animationName.includes('rainbow') || 
                                style.backgroundColor.includes('255, 0, 0')) {
                                affectedElements++;
                            }
                        });
                        
                        if (affectedElements === 0) {
                            report += '<p>‚úÖ Perfect isolation - no elements affected by extreme styles</p>';
                        } else {
                            report += `<p>‚ö†Ô∏è ${affectedElements} elements affected by external styles</p>`;
                        }
                        
                        // Performance impact test
                        const startTime = performance.now();
                        for (let i = 0; i < 100; i++) {
                            getComputedStyle(widgetElements[0]);
                        }
                        const endTime = performance.now();
                        
                        report += `<p>‚ö° Style computation performance: ${Math.round(endTime - startTime)}ms for 100 computations</p>`;
                    }
                    
                    results.innerHTML = report;
                    
                } else {
                    results.innerHTML = '<h3>‚ùå Stress test failed - widget initialization failed</h3>';
                }
                
            } catch (error) {
                results.innerHTML = '<h3>‚ùå Stress test error: ' + error.message + '</h3>';
            }
        }
        
        window.addEventListener('load', runStressTest);
    </script>
</body>
</html>