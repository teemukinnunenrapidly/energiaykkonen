<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Compatibility CSS Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .browser-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .browser-test { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .supported { border-color: #4caf50; background: #f1f8e9; }
        .not-supported { border-color: #f44336; background: #ffebee; }
        .user-agent-test { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Browser Compatibility CSS Isolation Test</h1>
    <p>This page tests CSS isolation across different browser environments.</p>
    
    <div class="browser-grid">
        <div class="browser-test" id="chrome-test">
            <h3>Chrome/Chromium Test</h3>
            <div class="user-agent-test" id="chrome-ua"></div>
            <div id="chrome-widget" data-e1-calculator></div>
            <div id="chrome-results">Loading...</div>
        </div>
        
        <div class="browser-test" id="firefox-test">
            <h3>Firefox Test</h3>
            <div class="user-agent-test" id="firefox-ua"></div>
            <div id="firefox-widget" data-e1-calculator></div>
            <div id="firefox-results">Loading...</div>
        </div>
        
        <div class="browser-test" id="safari-test">
            <h3>Safari Test</h3>
            <div class="user-agent-test" id="safari-ua"></div>
            <div id="safari-widget" data-e1-calculator></div>
            <div id="safari-results">Loading...</div>
        </div>
        
        <div class="browser-test" id="edge-test">
            <h3>Edge Test</h3>
            <div class="user-agent-test" id="edge-ua"></div>
            <div id="edge-widget" data-e1-calculator></div>
            <div id="edge-results">Loading...</div>
        </div>
        
        <div class="browser-test" id="ie11-test">
            <h3>IE11 Test (Simulation)</h3>
            <div class="user-agent-test" id="ie11-ua"></div>
            <div id="ie11-widget" data-e1-calculator></div>
            <div id="ie11-results">Loading...</div>
        </div>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
        <h3>Overall Browser Compatibility Results</h3>
        <div id="overall-results">Running tests...</div>
    </div>
    
    <script src="../../../dist/e1-calculator-widget.min.js"></script>
    <script>
        const browserTests = [
            {
                id: 'chrome',
                name: 'Chrome/Chromium',
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                shadowSupport: true
            },
            {
                id: 'firefox',
                name: 'Firefox',
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0',
                shadowSupport: true
            },
            {
                id: 'safari',
                name: 'Safari',
                userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15',
                shadowSupport: true
            },
            {
                id: 'edge',
                name: 'Edge',
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0',
                shadowSupport: true
            },
            {
                id: 'ie11',
                name: 'Internet Explorer 11',
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko',
                shadowSupport: false
            }
        ];
        
        async function runBrowserCompatibilityTests() {
            const results = [];
            
            for (const browser of browserTests) {
                const result = await testBrowserCompatibility(browser);
                results.push(result);
            }
            
            updateOverallResults(results);
        }
        
        async function testBrowserCompatibility(browser) {
            const uaElement = document.getElementById(`${browser.id}-ua`);
            const resultsElement = document.getElementById(`${browser.id}-results`);
            const testElement = document.getElementById(`${browser.id}-test`);
            
            // Display user agent
            uaElement.textContent = browser.userAgent;
            
            try {
                // Simulate browser environment
                const originalUA = navigator.userAgent;
                Object.defineProperty(navigator, 'userAgent', {
                    value: browser.userAgent,
                    configurable: true
                });
                
                // Test widget initialization
                const widget = await window.E1Calculator.init(`${browser.id}-widget`, {
                    useShadowDOM: browser.shadowSupport
                });
                
                // Restore original UA
                Object.defineProperty(navigator, 'userAgent', {
                    value: originalUA,
                    configurable: true
                });
                
                if (widget) {
                    const expectedMode = browser.shadowSupport ? 'shadow' : 'namespace';
                    const actualMode = widget.mode;
                    const modeCorrect = actualMode === expectedMode;
                    
                    let report = `<p><strong>Mode:</strong> ${actualMode} ${modeCorrect ? '✅' : '❌'}</p>`;
                    report += `<p><strong>Expected:</strong> ${expectedMode}</p>`;
                    
                    if (browser.shadowSupport) {
                        const container = document.getElementById(`${browser.id}-widget`);
                        const hasShadowRoot = !!container.shadowRoot;
                        report += `<p><strong>Shadow Root:</strong> ${hasShadowRoot ? '✅ Yes' : '❌ No'}</p>`;
                    }
                    
                    resultsElement.innerHTML = report;
                    testElement.className += modeCorrect ? ' supported' : ' not-supported';
                    
                    return {
                        browser: browser.name,
                        success: true,
                        mode: actualMode,
                        expected: expectedMode,
                        correct: modeCorrect
                    };
                    
                } else {
                    resultsElement.innerHTML = '<p>❌ Widget initialization failed</p>';
                    testElement.className += ' not-supported';
                    
                    return {
                        browser: browser.name,
                        success: false,
                        error: 'Initialization failed'
                    };
                }
                
            } catch (error) {
                resultsElement.innerHTML = '<p>❌ Test error: ' + error.message + '</p>';
                testElement.className += ' not-supported';
                
                return {
                    browser: browser.name,
                    success: false,
                    error: error.message
                };
            }
        }
        
        function updateOverallResults(results) {
            const overallElement = document.getElementById('overall-results');
            
            const successful = results.filter(r => r.success).length;
            const total = results.length;
            
            let report = `<h4>Browser Compatibility Summary: ${successful}/${total} passed</h4>`;
            
            results.forEach(result => {
                if (result.success) {
                    const status = result.correct ? '✅' : '⚠️';
                    report += `<p>${status} <strong>${result.browser}:</strong> ${result.mode} mode</p>`;
                } else {
                    report += `<p>❌ <strong>${result.browser}:</strong> ${result.error}</p>`;
                }
            });
            
            // Browser compatibility matrix
            report += '<h4>CSS Isolation Support Matrix</h4>';
            report += '<table border="1" style="border-collapse: collapse; width: 100%;">';
            report += '<tr><th>Browser</th><th>Shadow DOM</th><th>Namespace</th><th>Recommendation</th></tr>';
            
            results.forEach(result => {
                const shadowSupport = browserTests.find(b => b.name === result.browser).shadowSupport;
                const recommendation = shadowSupport ? 'Shadow DOM' : 'Namespace';
                
                report += `<tr>`;
                report += `<td>${result.browser}</td>`;
                report += `<td>${shadowSupport ? '✅' : '❌'}</td>`;
                report += `<td>✅</td>`; // Namespace should work everywhere
                report += `<td>${recommendation}</td>`;
                report += `</tr>`;
            });
            
            report += '</table>';
            
            overallElement.innerHTML = report;
        }
        
        window.addEventListener('load', () => {
            setTimeout(runBrowserCompatibilityTests, 1000);
        });
    </script>
</body>
</html>